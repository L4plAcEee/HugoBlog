<!DOCTYPE html>
<html lang="zh-cn">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='http://localhost:1313/js/theme-mode.js'></script>
    <link rel="stylesheet" href='http://localhost:1313/css/frameworks.min.css' />
    <link rel="stylesheet" href='http://localhost:1313/css/github.min.css' />
    <link rel="stylesheet" href='http://localhost:1313/css/github-style.css' />
    <link rel="stylesheet" href='http://localhost:1313/css/light.css' />
    <link rel="stylesheet" href='http://localhost:1313/css/dark.css' />
    <link rel="stylesheet" href='http://localhost:1313/css/syntax.css' />
    <title>【N0te】数据挖掘实验 - L4place&#39;s blog</title>
    
    <link rel="icon" type="image/x-icon" href='/images/github-mark.png'>
    
    <meta name="theme-color" content="#1e2327">

    
    

    
    <meta name="description"
  content="数据挖掘基础操作学习，以及各种常见算法模型的应用，最后构建自己的推荐算法。" />
<meta name="keywords"
  content='blog, google analytics' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="http://localhost:1313/post/0x03-data-dipping-exp/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="【N0te】数据挖掘实验 - L4place&#39;s blog" />
<meta name="twitter:description"
  content="数据挖掘基础操作学习，以及各种常见算法模型的应用，最后构建自己的推荐算法。" />
<meta name="twitter:site" content="http://localhost:1313/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="http://localhost:1313/">


<meta property="og:type" content="article" />
<meta property="og:title" content="【N0te】数据挖掘实验 - L4place&#39;s blog">
<meta property="og:description"
  content="数据挖掘基础操作学习，以及各种常见算法模型的应用，最后构建自己的推荐算法。" />
<meta property="og:url" content="http://localhost:1313/post/0x03-data-dipping-exp/" />
<meta property="og:site_name" content="【N0te】数据挖掘实验" />
<meta property="og:image"
  content="http://localhost:1313/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2026-01-01 02:44:08 &#43;0800 CST" />











</head>


<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="http://localhost:1313/">
        <img class="octicon" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:http://localhost:1313/">
            </label>
          </form>
          
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="http://localhost:1313/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  <div id="search-result" class="container-lg px-3 new-discussion-timeline" style="display: none;">
</div>

  
<div class="application-main">
  <div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="http://localhost:1313/">
                  <img class=" avatar-user"
                    src="/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="http://localhost:1313/">L4place</a>
                  </span>
                  <span class="path-divider">/</span>
                  <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px">
                    <a href="http://localhost:1313/post/0x03-data-dipping-exp/">【N0te】数据挖掘实验</a>
                  </strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Thu, 01 Jan 2026 02:44:08 &#43;0800"
                    class="no-wrap">
                    Thu, 01 Jan 2026 02:44:08 &#43;0800</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Thu, 01 Jan 2026 02:48:57 &#43;0800"
                    class="no-wrap">
                    Thu, 01 Jan 2026 02:48:57 &#43;0800</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      37502 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/python">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      Python
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      实验笔记
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><h1 id="1-实验一数据清洗与处理">1. 实验一：数据清洗与处理</h1>
<h3 id="实验要求">实验要求</h3>
<table>
  <thead>
      <tr>
          <th><strong>实验目的：</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->1、搭建好Windows版本的Python开发平台，并在该平台上安装一系列第三方的扩展库；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、通过检验数据集的数据质量、绘制图表、计算某些特征等手段，对样本数据集的结构和规律进行分析，学会使用第三方拓展库对数据进行探索；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、学会对原始数据中的缺失值、异常值进行处理；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、针对原始数据集中的脏数据，能够通过Python及其拓展库对数据进行集成、规约、转换等操作</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>实验内容：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、 从Python官网https://www.python.org/ 下载3.6版本的Python；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、 下载Python环境管理软件Anaconda并熟悉它的使用；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、 对abalone.data数据文件进行预处理，使得其转化为包含表头的csv文件（命名为abalone.csv），读取并打印前10行数据；<!-- raw HTML omitted --><!-- raw HTML omitted -->4、 查看是否有属性存在空值；<!-- raw HTML omitted --><!-- raw HTML omitted -->5、 绘制每一个数值型属性的直方图，查看其分布，输出符合正态分布的属性及其直方图，从中挑一个属性，利用3σ原则分析异常值；<!-- raw HTML omitted --><!-- raw HTML omitted -->6、 针对带壳肉高度，画出其箱型图，并运用箱型图分析法进行异常检测，将异常值输出；<!-- raw HTML omitted --><!-- raw HTML omitted -->7、 判断外壳长度与高度、整只鲍鱼重量是否相关，若相关，输出相关系数的值，并判断哪一个相关性更大；<!-- raw HTML omitted --><!-- raw HTML omitted -->8、 针对外壳长度和整只鲍鱼重量两个属性建立关系，使用拉格朗日插值方法针对外壳长度为0.137、0.172的重量进行插补，将插补结果进行输出，并画出程序流程图；<!-- raw HTML omitted --><!-- raw HTML omitted -->9、 使用Z-score对肉的重量属性进行规范化处理；<!-- raw HTML omitted --><!-- raw HTML omitted -->10、 附加题：尝试使用PCA对原始数据样本进行降维，α设置为0.6，并将降维结果进行输出；<!-- raw HTML omitted --><!-- raw HTML omitted -->11、 将上述实验内容的核心代码及实验结果截图放到“实验过程及分析”中。</td>
      </tr>
  </tbody>
</table>
<h3 id="实验过程以及分析">实验过程以及分析</h3>
<h4 id="代码实现">代码实现</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">data_file_path</span> <span class="o">=</span> <span class="s2">&#34;abalone/abalone.data&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="n">csv_file_path</span> <span class="o">=</span> <span class="s2">&#34;abalone/abalone.csv&#34;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">skew</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 3、对abalone.data数据文件进行预处理，使得其转化为包含表头的csv文件（命名为abalone.csv），读取并打印前10行数据；  </span>
</span></span><span class="line"><span class="cl"><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;Sex&#34;</span><span class="p">,</span> <span class="s2">&#34;Length&#34;</span><span class="p">,</span> <span class="s2">&#34;Diameter&#34;</span><span class="p">,</span> <span class="s2">&#34;Height&#34;</span><span class="p">,</span> <span class="s2">&#34;Whole weight&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">           <span class="s2">&#34;Shucked weight&#34;</span><span class="p">,</span> <span class="s2">&#34;Viscera weight&#34;</span><span class="p">,</span> <span class="s2">&#34;Shell weight&#34;</span><span class="p">,</span> <span class="s2">&#34;Rings&#34;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 4、查看是否有属性存在空值；  </span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">null_counts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">null_counts</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 5、绘制每一个数值型属性的直方图，查看其分布，输出符合正态分布的属性及其直方图，从中挑一个属性，利用3σ原则分析异常值；  </span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">numeric_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;Length&#34;</span><span class="p">,</span> <span class="s2">&#34;Diameter&#34;</span><span class="p">,</span> <span class="s2">&#34;Height&#34;</span><span class="p">,</span> <span class="s2">&#34;Whole weight&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                   <span class="s2">&#34;Shucked weight&#34;</span><span class="p">,</span> <span class="s2">&#34;Viscera weight&#34;</span><span class="p">,</span> <span class="s2">&#34;Shell weight&#34;</span><span class="p">,</span> <span class="s2">&#34;Rings&#34;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-darkgrid&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">normal_attributes</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">## 用于正常显示负号  </span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 绘制所有数值型属性的直方图  </span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">numeric_columns</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## 计算偏度值，通常偏度绝对值较小（例如 &lt; 0.5）可以认为近似正态分布  </span>
</span></span><span class="line"><span class="cl">    <span class="n">skewness</span> <span class="o">=</span> <span class="n">skew</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skewness=</span><span class="si">{</span><span class="n">skewness</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## 如果偏度绝对值小于0.5，则认为近似正态  </span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">skewness</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">normal_attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;近似符合正态分布的属性：&#34;</span><span class="p">,</span> <span class="n">normal_attributes</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">attr</span> <span class="o">=</span> <span class="s2">&#34;Length&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="n">attr_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">mean_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">attr_data</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">std_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">attr_data</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">lower_bound</span> <span class="o">=</span> <span class="n">mean_val</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">std_val</span>  
</span></span><span class="line"><span class="cl"><span class="n">upper_bound</span> <span class="o">=</span> <span class="n">mean_val</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">std_val</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">outliers</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">attr_data</span> <span class="o">&lt;</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">attr_data</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;属性 &#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&#39; 的均值：</span><span class="si">{</span><span class="n">mean_val</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">，标准差：</span><span class="si">{</span><span class="n">std_val</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;根据3σ原则，阈值为 [</span><span class="si">{</span><span class="n">lower_bound</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">upper_bound</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;&#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&#39; 属性中异常值的数量：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;异常值数据预览：&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">outliers</span><span class="p">[[</span><span class="n">attr</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 绘制选择属性的直方图，并标出3σ范围  </span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">attr_data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;下界&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;上界&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2"> 的直方图及3σ异常值界限&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;频数&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 6、针对带壳肉高度，画出其箱型图，并运用箱型图分析法进行异常检测，将异常值输出；  </span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">height_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&#34;Height&#34;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 计算第一四分位数、第三四分位数及四分位距  </span>
</span></span><span class="line"><span class="cl"><span class="n">Q1</span> <span class="o">=</span> <span class="n">height_data</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">Q3</span> <span class="o">=</span> <span class="n">height_data</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 根据箱型图异常值判断标准：小于 Q1-1.5*IQR 或大于 Q3+1.5*IQR 的数据认为是异常值  </span>
</span></span><span class="line"><span class="cl"><span class="n">lower_bound</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span>  
</span></span><span class="line"><span class="cl"><span class="n">upper_bound</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 筛选出异常值  </span>
</span></span><span class="line"><span class="cl"><span class="n">outliers</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">height_data</span> <span class="o">&lt;</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">height_data</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;带壳肉高度异常值：&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">outliers</span><span class="p">[</span><span class="s2">&#34;Height&#34;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 绘制箱型图  </span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">height_data</span><span class="p">,</span> <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">            <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&#34;lightblue&#34;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&#34;blue&#34;</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">            <span class="n">medianprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&#34;red&#34;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;带壳肉高度箱型图&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&#34;Height&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 7、判断外壳长度与高度、整只鲍鱼重量是否相关，若相关，输出相关系数的值，并判断哪一个相关性更大；  </span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 计算外壳长度（Length）与高度（Height）的皮尔逊相关系数  </span>
</span></span><span class="line"><span class="cl"><span class="n">corr_length_height</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Height&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 计算外壳长度（Length）与整只鲍鱼重量（Whole weight）的皮尔逊相关系数  </span>
</span></span><span class="line"><span class="cl"><span class="n">corr_length_whole</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Whole weight&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 输出相关系数  </span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;外壳长度与高度的相关系数：&#34;</span><span class="p">,</span> <span class="n">corr_length_height</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;外壳长度与整只鲍鱼重量的相关系数：&#34;</span><span class="p">,</span> <span class="n">corr_length_whole</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 判断哪一个相关性更大（比较相关系数绝对值）  </span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr_length_height</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr_length_whole</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;外壳长度与高度的相关性更强。&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr_length_height</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr_length_whole</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;外壳长度与整只鲍鱼重量的相关性更强。&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;外壳长度与高度和整只鲍鱼重量的相关性相近。&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 针对外壳长度和整只鲍鱼重量两个属性建立关系，使用拉格朗日插值方法针对外壳长度为0.137、0.172的重量进行插补，将插补结果进行输出；  </span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">lagrange</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 按外壳长度排序，并选取较小外壳长度的4个数据点用于局部插值  </span>
</span></span><span class="line"><span class="cl"><span class="n">sorted_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&#34;Length&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">subset</span> <span class="o">=</span> <span class="n">sorted_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 提取外壳长度和整只鲍鱼重量的值  </span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&#34;Length&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&#34;Whole weight&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 显示选取的数据点  </span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;选取用于插值的数据点：&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Length = </span><span class="si">{</span><span class="n">xi</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, Whole weight = </span><span class="si">{</span><span class="n">yi</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 利用拉格朗日插值方法构建插值多项式  </span>
</span></span><span class="line"><span class="cl"><span class="n">poly</span> <span class="o">=</span> <span class="n">lagrange</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 对指定的外壳长度进行插值，并匹配最近的数据点  </span>
</span></span><span class="line"><span class="cl"><span class="n">lengths_to_interp</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.137</span><span class="p">,</span> <span class="mf">0.172</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="n">interp_results</span> <span class="o">=</span> <span class="p">{}</span>  
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">length_val</span> <span class="ow">in</span> <span class="n">lengths_to_interp</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## 查找与目标外壳长度最接近的实际数据点  </span>
</span></span><span class="line"><span class="cl">    <span class="n">closest_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">length_val</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">    <span class="n">closest_length</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">closest_idx</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">    <span class="n">closest_weight</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">closest_idx</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## 如果插值点在数据范围外，使用最接近的点的值  </span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">length_val</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">length_val</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="n">interp_results</span><span class="p">[</span><span class="n">length_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">closest_weight</span>  
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">interp_weight</span> <span class="o">=</span> <span class="n">poly</span><span class="p">(</span><span class="n">length_val</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">interp_results</span><span class="p">[</span><span class="n">length_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_weight</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;外壳长度为 </span><span class="si">{</span><span class="n">length_val</span><span class="si">}</span><span class="s2"> 时，插补的整只鲍鱼重量为：</span><span class="si">{</span><span class="n">interp_results</span><span class="p">[</span><span class="n">length_val</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 9、使用Z-score对肉的重量属性进行规范化处理；  </span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">shucked</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&#34;Shucked weight&#34;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 计算均值和标准差  </span>
</span></span><span class="line"><span class="cl"><span class="n">mean_val</span> <span class="o">=</span> <span class="n">shucked</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"><span class="n">std_val</span> <span class="o">=</span> <span class="n">shucked</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 使用Z-score公式进行规范化处理  </span>
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="p">[</span><span class="s2">&#34;Shucked weight_zscore&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">shucked</span> <span class="o">-</span> <span class="n">mean_val</span><span class="p">)</span> <span class="o">/</span> <span class="n">std_val</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 输出前几行查看规范化后的结果  </span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="s2">&#34;Shucked weight&#34;</span><span class="p">,</span> <span class="s2">&#34;Shucked weight_zscore&#34;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</span></span></code></pre></div><h4 id="运行结果">运行结果</h4>
<h5 id="终端输出">终端输出</h5>
<pre tabindex="0"><code>  Sex  Length  Diameter  ...  Viscera weight  Shell weight  Rings
0   M   0.455     0.365  ...          0.1010         0.150     15
1   M   0.350     0.265  ...          0.0485         0.070      7
2   F   0.530     0.420  ...          0.1415         0.210      9
3   M   0.440     0.365  ...          0.1140         0.155     10
4   I   0.330     0.255  ...          0.0395         0.055      7
5   I   0.425     0.300  ...          0.0775         0.120      8
6   F   0.530     0.415  ...          0.1415         0.330     20
7   F   0.545     0.425  ...          0.1495         0.260     16
8   M   0.475     0.370  ...          0.1125         0.165      9
9   F   0.550     0.440  ...          0.1510         0.320     19

[10 rows x 9 columns]
Sex               0
Length            0
Diameter          0
Height            0
Whole weight      0
Shucked weight    0
Viscera weight    0
Shell weight      0
Rings             0
dtype: int64
近似符合正态分布的属性： []
属性 &#39;Length&#39; 的均值：0.52，标准差：0.12
根据3σ原则，阈值为 [0.16, 0.88]
&#39;Length&#39; 属性中异常值的数量：15
异常值数据预览：
     Length
236   0.075
237   0.130
238   0.110
239   0.160
526   0.155
带壳肉高度异常值：
236     0.010
237     0.030
238     0.030
239     0.035
306     0.030
694     0.020
718     0.035
719     0.025
720     0.025
1174    0.015
1257    0.000
1417    0.515
1428    0.250
1429    0.035
1763    0.250
1987    0.025
2051    1.130
2114    0.035
2169    0.015
2171    0.030
2172    0.030
2179    0.250
2381    0.025
2711    0.030
3190    0.025
3837    0.035
3899    0.035
3902    0.020
3996    0.000
Name: Height, dtype: float64
外壳长度与高度的相关系数： 0.8275536093192105
外壳长度与整只鲍鱼重量的相关系数： 0.9252611721489453
外壳长度与整只鲍鱼重量的相关性更强。
选取用于插值的数据点：
Length = 0.075, Whole weight = 0.002
Length = 0.110, Whole weight = 0.008
Length = 0.130, Whole weight = 0.013
Length = 0.130, Whole weight = 0.011
外壳长度为 0.137 时，插补的整只鲍鱼重量为：0.013
外壳长度为 0.172 时，插补的整只鲍鱼重量为：0.013

  return poly1d(self.coeffs/other)
   Shucked weight  Shucked weight_zscore
0          0.2245              -0.607613
1          0.0995              -1.170770
2          0.2565              -0.463444
3          0.2155              -0.648160
4          0.0895              -1.215822
</code></pre><h5 id="图表输出">图表输出</h5>
<p><img src="f25325b9348ea448dacc7a714d018268_MD5.webp" alt=""></p>
<p><img src="a02160bdbb0ff9ae17e942cfb84dd1ea_MD5.webp" alt=""></p>
<p><img src="b1a0d82db9719555d121a52e4b8e0a26_MD5.webp" alt=""></p>
<h5 id="流程图绘制">流程图绘制</h5>
<p><img src="ea4a1a5260003f8f0c16866951edb52d_MD5.webp" alt=""></p>
<h3 id="实验体会与总结">实验体会与总结</h3>
<hr>
<h1 id="2-实验二分类与预测算法">2. 实验二：分类与预测算法</h1>
<h3 id="实验要求-1">实验要求</h3>
<table>
  <thead>
      <tr>
          <th>实验目的：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、理解分类与预测算法的原理；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、能够使用分类与预测模型处理具体问题；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、能够使用Python语言实现分类与预测算法。</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>实验内容：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、 读取数据文件bankloan.xls，使用随机种子将原始数据集打乱，将数据集划分为训练集和测试集，比例为8：2；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、 使用Logistic回归模型进行建模，计算准确率；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、 更改模型参数，使得准确率进一步上升，并进行具体分析（比如调节了何参数？为何使得模型得到改善？）；<!-- raw HTML omitted --><!-- raw HTML omitted -->4、 读取数据文件bupa.data，按照bupa.names文件里要求的将bupa.data数据集划分为训练集和测试集；<!-- raw HTML omitted --><!-- raw HTML omitted -->5、 使用合适的模型对bupa.data文件中的数据进行建模，并给予文字说明为什么要选择这一模型；<!-- raw HTML omitted --><!-- raw HTML omitted -->6、 调节模型参数，使得最终训练得到的模型评价指标较好，并输出最终评价指标的值；<!-- raw HTML omitted --><!-- raw HTML omitted -->7、 在不同的参数下，画出模型运行过程中的损失下降图，以迭代次数为横坐标，损失值为纵坐标； <!-- raw HTML omitted --><!-- raw HTML omitted -->8、 将上述实验内容的核心代码及实验结果截图放到“实验过程及分析”中。</td>
      </tr>
  </tbody>
</table>
<h3 id="实验过程以及分析-1">实验过程以及分析</h3>
<h5 id="代码实现-1">代码实现</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">GridSearchCV</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">SGDClassifier</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">log_loss</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">warnings</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.exceptions</span> <span class="kn">import</span> <span class="n">ConvergenceWarning</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 全局忽略 SGDClassifier 的未收敛警告  </span>
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&#34;ignore&#34;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">ConvergenceWarning</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 字体配置  </span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 1. 读取 bankloan.xls 并划分数据集（8:2）  </span>
</span></span><span class="line"><span class="cl"><span class="n">bankloan</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;./data/bankloan.xls&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;xlrd&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### 列名示例：[&#39;年龄&#39;,&#39;教育&#39;,&#39;工龄&#39;,&#39;地址&#39;,&#39;收入&#39;,&#39;负债率&#39;,&#39;信用卡负债&#39;,&#39;其他负债&#39;,&#39;违约&#39;]  </span>
</span></span><span class="line"><span class="cl"><span class="n">X_bank</span> <span class="o">=</span> <span class="n">bankloan</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;违约&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl"><span class="n">y_bank</span> <span class="o">=</span> <span class="n">bankloan</span><span class="p">[</span><span class="s1">&#39;违约&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="n">Xb_train</span><span class="p">,</span> <span class="n">Xb_test</span><span class="p">,</span> <span class="n">yb_train</span><span class="p">,</span> <span class="n">yb_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">    <span class="n">X_bank</span><span class="p">,</span> <span class="n">y_bank</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>  
</span></span><span class="line"><span class="cl"><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 2. 使用 Logistic 回归模型基线建模，并计算准确率  </span>
</span></span><span class="line"><span class="cl"><span class="n">log_reg</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">log_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xb_train</span><span class="p">,</span> <span class="n">yb_train</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">y_pred</span> <span class="o">=</span> <span class="n">log_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xb_test</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">acc_baseline</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">yb_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Logistic 回归基线准确率：</span><span class="si">{</span><span class="n">acc_baseline</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 3. 调参：使用 GridSearchCV 优化正则化强度 Cparam_grid = {&#39;C&#39;: [0.01, 0.1, 1, 10, 100]}  </span>
</span></span><span class="line"><span class="cl"><span class="n">grid_log</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">    <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">    <span class="n">param_grid</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>  
</span></span><span class="line"><span class="cl"><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">grid_log</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xb_train</span><span class="p">,</span> <span class="n">yb_train</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">best_log</span> <span class="o">=</span> <span class="n">grid_log</span><span class="o">.</span><span class="n">best_estimator_</span>  
</span></span><span class="line"><span class="cl"><span class="n">y_pred_best</span> <span class="o">=</span> <span class="n">best_log</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xb_test</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">acc_tuned</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">yb_test</span><span class="p">,</span> <span class="n">y_pred_best</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Logistic 最优 C：</span><span class="si">{</span><span class="n">grid_log</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;调参后准确率：</span><span class="si">{</span><span class="n">acc_tuned</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 4. 读取 bupa.data，并按要求划分（8:2）  </span>
</span></span><span class="line"><span class="cl"><span class="c1">### bupa.names 中字段：mcv, alkphos, sgpt, sgot, gammagt, drinks, selector  </span>
</span></span><span class="line"><span class="cl"><span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mcv&#39;</span><span class="p">,</span> <span class="s1">&#39;alkphos&#39;</span><span class="p">,</span> <span class="s1">&#39;sgpt&#39;</span><span class="p">,</span> <span class="s1">&#39;sgot&#39;</span><span class="p">,</span> <span class="s1">&#39;gammagt&#39;</span><span class="p">,</span> <span class="s1">&#39;drinks&#39;</span><span class="p">,</span> <span class="s1">&#39;selector&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="n">bupa</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/bupa.data&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">col_names</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="c1">### selector 原为 1=肝病，2=正常，转换为 0/1（二分类）  </span>
</span></span><span class="line"><span class="cl"><span class="n">bupa</span><span class="p">[</span><span class="s1">&#39;selector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bupa</span><span class="p">[</span><span class="s1">&#39;selector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>  
</span></span><span class="line"><span class="cl"><span class="n">X_bupa</span> <span class="o">=</span> <span class="n">bupa</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;selector&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl"><span class="n">y_bupa</span> <span class="o">=</span> <span class="n">bupa</span><span class="p">[</span><span class="s1">&#39;selector&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="n">Xbupa_train</span><span class="p">,</span> <span class="n">Xbupa_test</span><span class="p">,</span> <span class="n">ybupa_train</span><span class="p">,</span> <span class="n">ybupa_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">    <span class="n">X_bupa</span><span class="p">,</span> <span class="n">y_bupa</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>  
</span></span><span class="line"><span class="cl"><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 5. 选择 RandomForestClassifier 建模（适合捕捉非线性与特征交互）  </span>
</span></span><span class="line"><span class="cl"><span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xbupa_train</span><span class="p">,</span> <span class="n">ybupa_train</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">y_pred_rf</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xbupa_test</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">acc_rf</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">ybupa_test</span><span class="p">,</span> <span class="n">y_pred_rf</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;RandomForest 基线准确率（Bupa 数据）：</span><span class="si">{</span><span class="n">acc_rf</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 6. RandomForest 参数调优  </span>
</span></span><span class="line"><span class="cl"><span class="n">param_grid_rf</span> <span class="o">=</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>  
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="n">grid_rf</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">    <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">    <span class="n">param_grid_rf</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>  
</span></span><span class="line"><span class="cl"><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">grid_rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xbupa_train</span><span class="p">,</span> <span class="n">ybupa_train</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">best_rf</span> <span class="o">=</span> <span class="n">grid_rf</span><span class="o">.</span><span class="n">best_estimator_</span>  
</span></span><span class="line"><span class="cl"><span class="n">y_pred_best_rf</span> <span class="o">=</span> <span class="n">best_rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xbupa_test</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">report_rf</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">ybupa_test</span><span class="p">,</span> <span class="n">y_pred_best_rf</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;RandomForest 最优参数：</span><span class="si">{</span><span class="n">grid_rf</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;RandomForest 调参后分类报告：&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">report_rf</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 7. 不同参数下的损失下降曲线（以 SGDClassifier 为例）  </span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">SGDClassifier</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">log_loss</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">sgd</span> <span class="o">=</span> <span class="n">SGDClassifier</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">    <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;log_loss&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">learning_rate</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">eta0</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">max_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">warm_start</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>  
</span></span><span class="line"><span class="cl"><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">loss_values</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl"><span class="n">epochs</span> <span class="o">=</span> <span class="mi">50</span>  
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="n">sgd</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xb_train</span><span class="p">,</span> <span class="n">yb_train</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">proba</span> <span class="o">=</span> <span class="n">sgd</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">Xb_test</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">loss</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">yb_test</span><span class="p">,</span> <span class="n">proba</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">loss_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">loss_values</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;迭代次数 (Epoch)&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;对数损失 (Log Loss)&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;SGDClassifier 在 BankLoan 测试集上的损失下降曲线&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><h5 id="结果">结果</h5>
<h6 id="终端">终端</h6>
<pre tabindex="0"><code>C:\Users\19065\miniconda3\python.exe D:\coding\简简单单挖掘个数据\exp02\main.py 
Logistic 回归基线准确率：0.8500
Logistic 最优 C：0.1
调参后准确率：0.8571
RandomForest 基线准确率（Bupa 数据）：0.8116
RandomForest 最优参数：{&#39;max_depth&#39;: 5, &#39;n_estimators&#39;: 50}
RandomForest 调参后分类报告：
              precision    recall  f1-score   support

           0       0.76      0.88      0.81        42
           1       0.75      0.56      0.64        27

    accuracy                           0.75        69
   macro avg       0.75      0.72      0.73        69
weighted avg       0.75      0.75      0.74        69


进程已结束，退出代码为 0
</code></pre><h6 id="图表">图表</h6>
<p><img src="dad8c2ffcef9e5814a3f6cde3d39a54a_MD5.webp" alt=""></p>
<h5 id="问题分析">问题分析</h5>
<p><strong>3. 模型参数调优分析</strong><br>
在 BankLoan 数据集上，我们使用了 Logistic 回归模型，并通过调整正则化强度参数 <strong>C</strong>（即正则化项的倒数）来提升模型的泛化性能：</p>
<ul>
<li>
<p><strong>基线模型</strong>：默认 <code>C=1.0</code> 时，模型在测试集上的准确率约为 0.8500。</p>
</li>
<li>
<p><strong>调优过程</strong>：使用 <code>GridSearchCV</code> 在 <code>{0.01, 0.1, 1, 10, 100}</code> 这五个候选值中进行 5 折交叉验证；</p>
</li>
<li>
<p><strong>最优结果</strong>：最终选出 <code>C=0.1</code>，此时测试集准确率提升至 0.8571。</p>
</li>
</ul>
<p><strong>为何调节 C 能带来改善？</strong></p>
<ul>
<li>
<p>Logistic 回归中，损失函数为带有 L2 正则化项的对数损失：</p>
<p>$L(\mathbf{w}) = -\sum_i\bigl[y_i\log p_i + (1-y_i)\log(1-p_i)\bigr] ;+; \frac{1}{2C}|\mathbf{w}|^2$.</p>
</li>
<li>
<p>当 C 较大（弱正则化）时，模型容易过拟合，权重 w 可能偏大以降低训练误差；</p>
</li>
<li>
<p>当 C 较小（强正则化）时，模型更倾向于保持权重较小，提高对噪声的鲁棒性，但若过强则会欠拟合；</p>
</li>
<li>
<p>通过交叉验证发现 C=0.1 在当前样本规模和特征分布下恰到好处地平衡了偏差与方差，从而在未见过数据上表现最佳。</p>
</li>
</ul>
<p><strong>4. 读取 bupa.data 并划分数据集</strong><br>
肝病（Bupa）数据集的 <code>bupa.names</code> 文件指出：</p>
<ol>
<li>
<p>数据文件无表头，包含 6 个特征与 1 个标签（selector）；</p>
</li>
<li>
<p>selector 取值 1 表示有肝病，2 表示正常；</p>
</li>
<li>
<p>无缺失值，均为数值型；</p>
</li>
</ol>
<p>基于此，我们的划分流程为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 读取时指定列名</span>
</span></span><span class="line"><span class="cl"><span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mcv&#39;</span><span class="p">,</span> <span class="s1">&#39;alkphos&#39;</span><span class="p">,</span> <span class="s1">&#39;sgpt&#39;</span><span class="p">,</span> <span class="s1">&#39;sgot&#39;</span><span class="p">,</span> <span class="s1">&#39;gammagt&#39;</span><span class="p">,</span> <span class="s1">&#39;drinks&#39;</span><span class="p">,</span> <span class="s1">&#39;selector&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">bupa</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/bupa.data&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">col_names</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 标签映射：1→1（肝病）；2→0（正常），方便二分类</span>
</span></span><span class="line"><span class="cl"><span class="n">bupa</span><span class="p">[</span><span class="s1">&#39;selector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bupa</span><span class="p">[</span><span class="s1">&#39;selector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 分割特征与标签</span>
</span></span><span class="line"><span class="cl"><span class="n">X</span> <span class="o">=</span> <span class="n">bupa</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;selector&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">=</span> <span class="n">bupa</span><span class="p">[</span><span class="s1">&#39;selector&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 按 8:2 划分训练集/测试集，保持随机种子以便复现</span>
</span></span><span class="line"><span class="cl"><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p><strong>5. 模型选择及理由</strong><br>
针对 Bupa 数据的特点——</p>
<ul>
<li>
<p><strong>样本量中等</strong>（345 行左右），</p>
</li>
<li>
<p><strong>特征维度低</strong>（仅 6 个数值特征），</p>
</li>
<li>
<p><strong>可能存在非线性特征交互</strong>（如某些指标组合时更能区分肝病状态），</p>
</li>
</ul>
<p>我们选择 <strong>RandomForestClassifier</strong> 作为基线模型，其优势包括：</p>
<ol>
<li>
<p><strong>无需对特征进行严格的线性假设</strong>，能自动捕捉复杂的非线性决策边界；</p>
</li>
<li>
<p><strong>对异常值和噪声具有鲁棒性</strong>，因为多个决策树投票可降低单棵树的过拟合风险；</p>
</li>
<li>
<p><strong>可输出特征重要性</strong>，便于后续进行特征选择或域内专家解释；</p>
</li>
<li>
<p><strong>参数易于调整</strong>（如树的数量 <code>n_estimators</code>、最大深度 <code>max_depth</code>），并能借助交叉验证快速找出最优组合。</p>
</li>
</ol>
<h3 id="实验体会与总结-1">实验体会与总结</h3>
<hr>
<h1 id="3-实验三决策树算法">3. 实验三：决策树算法</h1>
<h3 id="实验要求-2">实验要求</h3>
<table>
  <thead>
      <tr>
          <th><strong>实验目的：</strong> <!-- raw HTML omitted --><!-- raw HTML omitted -->1、理解决策树算法的原理；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、能够使用决策树算法处理具体问题；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、能够使用Python语言实现决策树算法。</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>实验内容：</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->1、 读取数据文件iris.data，使用随机种子将原始数据集打乱，将数据集划分为训练集和测试集，比例为8：2；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、 使用ID3决策树在训练集上进行建模（注意：ID3决策树只能处理离散型数据，如果输入属性为连续型需要进行属性离散化），并将决策树通过图片的形式进行展现（使用Graphviz工具）；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、 使用测试集对2中构建好的决策树进行检验，并计算其准确率；<!-- raw HTML omitted --><!-- raw HTML omitted -->4、 使用C4.5算法在训练集上进行建模，并将决策树通过图片的形式进行展现（使用Graphviz工具）；<!-- raw HTML omitted --><!-- raw HTML omitted -->5、 使用测试集对4中构建好的决策树进行检验，并计算其准确率<!-- raw HTML omitted --><!-- raw HTML omitted -->6、 读取给定的数据集watermelon.txt，构建其决策树，并通过图片的形式展现（使用Graphviz工具）； <!-- raw HTML omitted --><!-- raw HTML omitted -->7、 将上述实验内容的核心代码及实验结果截图放到“实验过程及分析”中。</td>
      </tr>
  </tbody>
</table>
<h3 id="实验过程以及分析-2">实验过程以及分析</h3>
<h4 id="1-数据准备">1. 数据准备</h4>
<h5 id="实验描述">实验描述</h5>
<p>读取数据文件iris.data，使用随机种子将原始数据集打乱，将数据集划分为训练集和测试集，比例为8：2；</p>
<h5 id="代码实现-2">代码实现</h5>
<p>首先，我们实现了加载和处理Iris数据集的函数：</p>
<ul>
<li><code>load_iris_data()</code>: 读取数据，设置随机种子打乱数据，并按8:2的比例划分训练集和测试集</li>
<li><code>discretize_features()</code>: 由于ID3算法不能直接处理连续型数据，此函数将连续特征离散化为几个区间</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">### 第1步：读取数据文件iris.data，打乱并划分数据集  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load_iris_data</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## 读取数据  </span>
</span></span><span class="line"><span class="cl">    <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sepal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;sepal_width&#39;</span><span class="p">,</span> <span class="s1">&#39;petal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;petal_width&#39;</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">    <span class="n">iris_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;iris.data&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">column_names</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 打乱数据（设置随机种子确保结果可复现）  </span>
</span></span><span class="line"><span class="cl">    <span class="n">iris_data</span> <span class="o">=</span> <span class="n">iris_data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 分离特征和标签  </span>
</span></span><span class="line"><span class="cl">    <span class="n">X</span> <span class="o">=</span> <span class="n">iris_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">iris_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 划分训练集和测试集 (8:2)    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)  </span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">iris_data</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 属性离散化函数（用于ID3算法）  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">discretize_features</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="n">X_train_discrete</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">X_test_discrete</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 使用训练集的数据来确定分箱边界  </span>
</span></span><span class="line"><span class="cl">        <span class="n">bins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">duplicates</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="n">retbins</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 对训练集进行离散化  </span>
</span></span><span class="line"><span class="cl">        <span class="n">X_train_discrete</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_lowest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 对测试集进行离散化（使用与训练集相同的分箱边界）  </span>
</span></span><span class="line"><span class="cl">        <span class="n">X_test_discrete</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_lowest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">X_train_discrete</span><span class="p">,</span> <span class="n">X_test_discrete</span>
</span></span></code></pre></div><h4 id="2-id3决策树算法实现">2. ID3决策树算法实现</h4>
<h5 id="实验描述-1">实验描述</h5>
<p>使用ID3决策树在训练集上进行建模（注意：ID3决策树只能处理离散型数据，如果输入属性为连续型需要进行属性离散化），并将决策树通过图片的形式进行展现（使用Graphviz工具）；</p>
<h5 id="代码实现-3">代码实现</h5>
<p>ID3决策树类(<code>ID3DecisionTree</code>)实现了以下核心功能：</p>
<ul>
<li><code>_entropy()</code>: 计算熵</li>
<li><code>_information_gain()</code>: 计算信息增益</li>
<li><code>_find_best_feature()</code>: 找到最佳分裂特征</li>
<li><code>_build_tree()</code>: 递归构建决策树</li>
<li><code>predict()</code>: 使用决策树进行预测</li>
<li><code>visualize()</code>: 使用Graphviz可视化决策树
ID3算法基于信息增益选择最佳分裂特征，对于每个节点，都选择信息增益最大的特征进行分裂。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">### ID3决策树算法实现  </span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ID3DecisionTree</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_tree</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;计算熵&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">entropy</span> <span class="o">=</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="n">entropy</span> <span class="o">-=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">entropy</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_information_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;计算信息增益&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="n">entropy_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entropy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 计算条件熵  </span>
</span></span><span class="line"><span class="cl">        <span class="n">values</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="n">weighted_entropy</span> <span class="o">=</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">subset_indices</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span>  
</span></span><span class="line"><span class="cl">            <span class="n">subset_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">subset_indices</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">weight</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="n">weighted_entropy</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entropy</span><span class="p">(</span><span class="n">subset_y</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 信息增益 = 父节点熵 - 条件熵  </span>
</span></span><span class="line"><span class="cl">        <span class="n">information_gain</span> <span class="o">=</span> <span class="n">entropy_parent</span> <span class="o">-</span> <span class="n">weighted_entropy</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">information_gain</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_find_best_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;找到最佳分裂特征&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="n">best_gain</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  
</span></span><span class="line"><span class="cl">        <span class="n">best_feature</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_information_gain</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">gain</span> <span class="o">&gt;</span> <span class="n">best_gain</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">best_gain</span> <span class="o">=</span> <span class="n">gain</span>  
</span></span><span class="line"><span class="cl">                <span class="n">best_feature</span> <span class="o">=</span> <span class="n">feature</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">best_feature</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_build_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 基本情况：所有样本属于同一类别  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;leaf&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 没有特征可分裂或达到最大深度  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">            <span class="n">most_common_label</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;leaf&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">most_common_label</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 找到最佳分裂特征  </span>
</span></span><span class="line"><span class="cl">        <span class="n">best_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_best_feature</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 如果无法找到有效的特征进行分裂  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">best_feature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">most_common_label</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;leaf&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">most_common_label</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 创建当前节点  </span>
</span></span><span class="line"><span class="cl">        <span class="n">tree</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">best_feature</span><span class="p">,</span> <span class="s1">&#39;children&#39;</span><span class="p">:</span> <span class="p">{}}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 根据特征值分裂  </span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">X</span><span class="p">[</span><span class="n">best_feature</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">            <span class="n">mask</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">best_feature</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span>  
</span></span><span class="line"><span class="cl">            <span class="n">subset_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">best_feature</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="n">subset_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">remaining_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_names</span> <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="n">best_feature</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 如果子集为空  </span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_X</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">most_common_label</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">                <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;leaf&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">most_common_label</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_tree</span><span class="p">(</span><span class="n">subset_X</span><span class="p">,</span> <span class="n">subset_y</span><span class="p">,</span> <span class="n">remaining_features</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tree</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;Model not trained yet!&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">predictions</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_predict_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;leaf&#39;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">feature</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="n">value</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 处理测试集中出现训练集中没有的值的情况  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## 返回所有子节点中多数类  </span>
</span></span><span class="line"><span class="cl">            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">labels</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">class_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;可视化决策树&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="n">dot</span> <span class="o">=</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Digraph</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Decision Tree&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 递归添加节点  </span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_add_nodes</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">class_names</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dot</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_add_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dot</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;leaf&#39;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">class_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">class_names</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Class: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">tree</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 添加子节点  </span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>  
</span></span><span class="line"><span class="cl">                <span class="n">child_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#34;</span>  
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_add_nodes</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">child_id</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 连接父节点和当前节点  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">parent_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">dot</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">edge_label</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dot</span>
</span></span></code></pre></div><h4 id="3-c45决策树算法实现">3. C4.5决策树算法实现</h4>
<h5 id="实验描述-2">实验描述</h5>
<p>使用C4.5算法在训练集上进行建模，并将决策树通过图片的形式进行展现（使用Graphviz工具）；</p>
<h5 id="代码实现-4">代码实现</h5>
<p>C4.5决策树类(<code>C45DecisionTree</code>)是ID3的改进版，主要区别在于：</p>
<ul>
<li>使用信息增益率(<code>_information_gain_ratio()</code>)而非信息增益来选择分裂特征</li>
<li>能够处理连续特征(<code>_handle_continuous_feature()</code>)，找到最佳分割阈值</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">C45DecisionTree</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_tree</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;计算熵&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">entropy</span> <span class="o">=</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="n">entropy</span> <span class="o">-=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">entropy</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_information_gain_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;计算信息增益率&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 计算信息增益  </span>
</span></span><span class="line"><span class="cl">        <span class="n">entropy_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entropy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">values</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="n">weighted_entropy</span> <span class="o">=</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 特征的固有信息  </span>
</span></span><span class="line"><span class="cl">        <span class="n">intrinsic_info</span> <span class="o">=</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">subset_indices</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span>  
</span></span><span class="line"><span class="cl">            <span class="n">subset_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">subset_indices</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">weight</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="n">weighted_entropy</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entropy</span><span class="p">(</span><span class="n">subset_y</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 计算特征的固有信息  </span>
</span></span><span class="line"><span class="cl">            <span class="n">intrinsic_info</span> <span class="o">-=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 信息增益和增益率  </span>
</span></span><span class="line"><span class="cl">        <span class="n">info_gain</span> <span class="o">=</span> <span class="n">entropy_parent</span> <span class="o">-</span> <span class="n">weighted_entropy</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 避免除以零  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">intrinsic_info</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">gain_ratio</span> <span class="o">=</span> <span class="n">info_gain</span> <span class="o">/</span> <span class="n">intrinsic_info</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">gain_ratio</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_handle_continuous_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;处理连续特征，找到最佳分割点&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 获取排序后的唯一值  </span>
</span></span><span class="line"><span class="cl">        <span class="n">unique_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">best_gain_ratio</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  
</span></span><span class="line"><span class="cl">        <span class="n">best_threshold</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 尝试每对相邻值的中点作为阈值  </span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">            <span class="n">threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">unique_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">unique_values</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 创建二值特征  </span>
</span></span><span class="line"><span class="cl">            <span class="n">X_temp</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">            <span class="n">X_temp</span><span class="p">[</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">_binary&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 计算这个二值特征的信息增益率  </span>
</span></span><span class="line"><span class="cl">            <span class="n">gain_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_information_gain_ratio</span><span class="p">(</span><span class="n">X_temp</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">_binary&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">gain_ratio</span> <span class="o">&gt;</span> <span class="n">best_gain_ratio</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">best_gain_ratio</span> <span class="o">=</span> <span class="n">gain_ratio</span>  
</span></span><span class="line"><span class="cl">                <span class="n">best_threshold</span> <span class="o">=</span> <span class="n">threshold</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">best_threshold</span><span class="p">,</span> <span class="n">best_gain_ratio</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_find_best_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;找到最佳分裂特征&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="n">best_gain_ratio</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  
</span></span><span class="line"><span class="cl">        <span class="n">best_feature</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">        <span class="n">best_threshold</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">        <span class="n">is_continuous</span> <span class="o">=</span> <span class="kc">False</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## 检查是否为连续特征（值的数量大于某个阈值）  </span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1">## 假设连续特征有很多唯一值  </span>
</span></span><span class="line"><span class="cl">                <span class="n">threshold</span><span class="p">,</span> <span class="n">gain_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_continuous_feature</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">gain_ratio</span> <span class="o">&gt;</span> <span class="n">best_gain_ratio</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">best_gain_ratio</span> <span class="o">=</span> <span class="n">gain_ratio</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">best_feature</span> <span class="o">=</span> <span class="n">feature</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">best_threshold</span> <span class="o">=</span> <span class="n">threshold</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">is_continuous</span> <span class="o">=</span> <span class="kc">True</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="c1">## 离散特征  </span>
</span></span><span class="line"><span class="cl">                <span class="n">gain_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_information_gain_ratio</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">gain_ratio</span> <span class="o">&gt;</span> <span class="n">best_gain_ratio</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">best_gain_ratio</span> <span class="o">=</span> <span class="n">gain_ratio</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">best_feature</span> <span class="o">=</span> <span class="n">feature</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">best_threshold</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">is_continuous</span> <span class="o">=</span> <span class="kc">False</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">best_feature</span><span class="p">,</span> <span class="n">best_threshold</span><span class="p">,</span> <span class="n">is_continuous</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_build_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 基本情况：所有样本属于同一类别  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;leaf&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 没有特征可分裂或达到最大深度  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">            <span class="n">most_common_label</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;leaf&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">most_common_label</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 找到最佳分裂特征  </span>
</span></span><span class="line"><span class="cl">        <span class="n">best_feature</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">is_continuous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_best_feature</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 如果无法找到有效的特征进行分裂  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">best_feature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">most_common_label</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;leaf&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">most_common_label</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 创建当前节点  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">is_continuous</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">tree</span> <span class="o">=</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">best_feature</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;is_continuous&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">threshold</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;children&#39;</span><span class="p">:</span> <span class="p">{}</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 根据阈值分裂  </span>
</span></span><span class="line"><span class="cl">            <span class="c1">## 小于等于阈值的子集  </span>
</span></span><span class="line"><span class="cl">            <span class="n">left_mask</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">best_feature</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold</span>  
</span></span><span class="line"><span class="cl">            <span class="n">left_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">left_mask</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">left_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">left_mask</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 大于阈值的子集  </span>
</span></span><span class="line"><span class="cl">            <span class="n">right_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">left_mask</span>  
</span></span><span class="line"><span class="cl">            <span class="n">right_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">right_mask</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">right_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">right_mask</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 为左子树构建子树  </span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_X</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">most_common_label</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">                <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;leaf&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">most_common_label</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_tree</span><span class="p">(</span><span class="n">left_X</span><span class="p">,</span> <span class="n">left_y</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 为右子树构建子树  </span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_X</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">most_common_label</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">                <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="s1">&#39;&gt;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;leaf&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">most_common_label</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="s1">&#39;&gt;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_tree</span><span class="p">(</span><span class="n">right_X</span><span class="p">,</span> <span class="n">right_y</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## 离散特征  </span>
</span></span><span class="line"><span class="cl">            <span class="n">tree</span> <span class="o">=</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">best_feature</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;is_continuous&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;children&#39;</span><span class="p">:</span> <span class="p">{}</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 根据特征值分裂  </span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">X</span><span class="p">[</span><span class="n">best_feature</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">                <span class="n">mask</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">best_feature</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span>  
</span></span><span class="line"><span class="cl">                <span class="n">subset_X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">                <span class="n">subset_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">                <span class="c1">## 如果子集为空  </span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_X</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">most_common_label</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;leaf&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">most_common_label</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_tree</span><span class="p">(</span><span class="n">subset_X</span><span class="p">,</span> <span class="n">subset_y</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tree</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;Model not trained yet!&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">predictions</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_predict_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;leaf&#39;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">feature</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_continuous&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">            <span class="n">value</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;&lt;=&#39;</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="s1">&#39;&gt;&#39;</span>  
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">value</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">key</span> <span class="o">=</span> <span class="n">value</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 处理测试集中出现训练集中没有的值的情况  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## 返回所有子节点中多数类  </span>
</span></span><span class="line"><span class="cl">            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">labels</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">class_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;可视化决策树&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="n">dot</span> <span class="o">=</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Digraph</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Decision Tree&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 递归添加节点  </span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_add_nodes</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">class_names</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dot</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_add_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dot</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;leaf&#39;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">class_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">class_names</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Class: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_continuous&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">                <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">tree</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">tree</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">tree</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 添加子节点  </span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>  
</span></span><span class="line"><span class="cl">                <span class="n">child_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#34;</span>  
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_add_nodes</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">child_id</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 连接父节点和当前节点  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">parent_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">dot</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">edge_label</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dot</span>
</span></span></code></pre></div><h4 id="4-评估和可视化">4. 评估和可视化</h4>
<h5 id="实验描述-3">实验描述</h5>
<ol>
<li>使用测试集对2中构建好的决策树进行检验，并计算其准确率</li>
<li>使用测试集对4中构建好的决策树进行检验，并计算其准确率</li>
</ol>
<h5 id="代码实现-5">代码实现</h5>
<ul>
<li><code>evaluate_model()</code>: 计算模型的预测准确率</li>
<li>每个决策树类都有<code>visualize()</code>方法，使用Graphviz库将决策树结构可视化为图像</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">### 评估函数  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">evaluate_model</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;计算准确率&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">correct</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y_true</span> <span class="o">==</span> <span class="n">y_pred</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
</span></span></code></pre></div><h4 id="5-西瓜数据集处理">5. 西瓜数据集处理</h4>
<h5 id="实验描述-4">实验描述</h5>
<p>读取给定的数据集watermelon.txt，构建其决策树，并通过图片的形式展现（使用Graphviz工具）；</p>
<h5 id="代码实现-6">代码实现</h5>
<ul>
<li><code>load_watermelon_data()</code>: 加载西瓜数据集</li>
<li>使用与Iris数据集相同的算法在西瓜数据集上构建决策树</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">### 西瓜数据集处理  
</span></span></span><span class="line"><span class="cl"><span class="n">def</span> <span class="nf">load_watermelon_data</span><span class="p">()</span><span class="o">:</span>  
</span></span><span class="line"><span class="cl">    <span class="s">&#34;&#34;&#34;加载西瓜数据集&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="o">:</span>  
</span></span><span class="line"><span class="cl">        <span class="err">##</span> <span class="err">使用中文逗号作为分隔符</span>  
</span></span><span class="line"><span class="cl">        <span class="n">watermelon_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="err">&#39;</span><span class="p">.</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">watermelon</span><span class="p">.</span><span class="n">txt</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sc">&#39;，&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">print</span><span class="p">(</span><span class="n">f</span><span class="s">&#34;成功加载西瓜数据集: </span><span class="p">{</span><span class="n">watermelon_data</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span><span class="err">行</span> <span class="n">x</span> <span class="p">{</span><span class="n">watermelon_data</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span><span class="err">列</span><span class="s">&#34;)  </span>
</span></span><span class="line"><span class="cl">        <span class="n">print</span><span class="p">(</span><span class="s">&#34;数据列名:&#34;</span><span class="p">,</span> <span class="n">list</span><span class="p">(</span><span class="n">watermelon_data</span><span class="p">.</span><span class="n">columns</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="err">##</span> <span class="err">检查目标变量列</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="err">&#39;质量&#39;</span> <span class="n">in</span> <span class="n">watermelon_data</span><span class="p">.</span><span class="nl">columns</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">target_column</span> <span class="o">=</span> <span class="err">&#39;质量&#39;</span>  
</span></span><span class="line"><span class="cl">        <span class="n">elif</span> <span class="err">&#39;好瓜&#39;</span> <span class="n">in</span> <span class="n">watermelon_data</span><span class="p">.</span><span class="nl">columns</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">target_column</span> <span class="o">=</span> <span class="err">&#39;好瓜&#39;</span>  
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="o">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">target_column</span> <span class="o">=</span> <span class="n">watermelon_data</span><span class="p">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="err">##</span> <span class="err">默认使用最后一列</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">print</span><span class="p">(</span><span class="n">f</span><span class="s">&#34;目标变量列名为：{target_column}&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">print</span><span class="p">(</span><span class="s">&#34;目标变量分布:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">print</span><span class="p">(</span><span class="n">watermelon_data</span><span class="p">[</span><span class="n">target_column</span><span class="p">].</span><span class="n">value_counts</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="err">##</span> <span class="err">分离特征和标签</span>  
</span></span><span class="line"><span class="cl">        <span class="n">X</span> <span class="o">=</span> <span class="n">watermelon_data</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">target_column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="n">watermelon_data</span><span class="p">[</span><span class="n">target_column</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">watermelon_data</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">except</span> <span class="n">Exception</span> <span class="n">as</span> <span class="nl">e</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">print</span><span class="p">(</span><span class="n">f</span><span class="s">&#34;加载西瓜数据集时出错: {str(e)}&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">print</span><span class="p">(</span><span class="s">&#34;错误详情:&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="o">:</span>  
</span></span><span class="line"><span class="cl">            <span class="err">##</span> <span class="err">尝试读取文件内容进行调试</span>  
</span></span><span class="line"><span class="cl">            <span class="n">with</span> <span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="n">watermelon</span><span class="p">.</span><span class="n">txt</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="p">)</span> <span class="n">as</span> <span class="nl">f</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()[</span><span class="o">:</span><span class="mi">5</span><span class="p">]</span>  <span class="err">##</span> <span class="err">读取前</span><span class="mi">5</span><span class="err">行</span>  
</span></span><span class="line"><span class="cl">            <span class="n">print</span><span class="p">(</span><span class="s">&#34;文件内容前5行:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="n">in</span> <span class="nl">content</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">print</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">        <span class="n">except</span> <span class="n">Exception</span> <span class="n">as</span> <span class="nl">read_error</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">print</span><span class="p">(</span><span class="n">f</span><span class="s">&#34;读取文件失败: {read_error}&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">None</span><span class="p">,</span> <span class="n">None</span><span class="p">,</span> <span class="n">None</span>
</span></span></code></pre></div><h4 id="主函数实验流程">主函数（实验流程）</h4>
<h5 id="描述">描述</h5>
<p>主函数将以上封装的代码组装好，并构建了整个完整的实验流程。</p>
<h5 id="代码实现-7">代码实现</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">### 主函数  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## 加载Iris数据集  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;加载Iris数据集...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">iris_data</span> <span class="o">=</span> <span class="n">load_iris_data</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;训练集大小: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2">，测试集大小: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 为ID3算法离散化数据  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">离散化特征(用于ID3算法)...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">X_train_discrete</span><span class="p">,</span> <span class="n">X_test_discrete</span> <span class="o">=</span> <span class="n">discretize_features</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## ID3决策树  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">使用ID3算法构建决策树...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">id3_tree</span> <span class="o">=</span> <span class="n">ID3DecisionTree</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">id3_tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_discrete</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 可视化ID3决策树  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;可视化ID3决策树...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">dot_id3</span> <span class="o">=</span> <span class="n">id3_tree</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">dot_id3</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s1">&#39;id3_tree&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;ID3决策树已保存为&#39;id3_tree.png&#39;&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 评估ID3决策树  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">评估ID3决策树...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">id3_predictions</span> <span class="o">=</span> <span class="n">id3_tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_discrete</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">id3_accuracy</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">y_test</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">id3_predictions</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;ID3决策树在测试集上的准确率: </span><span class="si">{</span><span class="n">id3_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## C4.5决策树  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">使用C4.5算法构建决策树...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">c45_tree</span> <span class="o">=</span> <span class="n">C45DecisionTree</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">c45_tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 可视化C4.5决策树  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;可视化C4.5决策树...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">dot_c45</span> <span class="o">=</span> <span class="n">c45_tree</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">dot_c45</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s1">&#39;c45_tree&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;C4.5决策树已保存为&#39;c45_tree.png&#39;&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 评估C4.5决策树  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">评估C4.5决策树...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">c45_predictions</span> <span class="o">=</span> <span class="n">c45_tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">c45_accuracy</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">y_test</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">c45_predictions</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;C4.5决策树在测试集上的准确率: </span><span class="si">{</span><span class="n">c45_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 西瓜数据集  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">处理西瓜数据集...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">X_watermelon</span><span class="p">,</span> <span class="n">y_watermelon</span><span class="p">,</span> <span class="n">watermelon_data</span> <span class="o">=</span> <span class="n">load_watermelon_data</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 构建决策树（使用ID3，因为西瓜数据集主要是离散特征）  </span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;为西瓜数据集构建决策树...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">watermelon_tree</span> <span class="o">=</span> <span class="n">ID3DecisionTree</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">watermelon_tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_watermelon</span><span class="p">,</span> <span class="n">y_watermelon</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 可视化西瓜数据集决策树  </span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;可视化西瓜数据集决策树...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">dot_watermelon</span> <span class="o">=</span> <span class="n">watermelon_tree</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">X_watermelon</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">dot_watermelon</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s1">&#39;watermelon_tree&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;西瓜数据集决策树已保存为&#39;watermelon_tree.png&#39;&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;处理西瓜数据集时出错: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;请确保&#39;watermelon.txt&#39;文件存在且格式正确&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h5 id="实验结果">实验结果</h5>
<h6 id="终端输出-1">终端输出</h6>
<pre tabindex="0"><code>C:\Users\19065\miniconda3\python.exe D:\coding\简简单单挖掘个数据\exp03\main.py 
加载Iris数据集...
训练集大小: 120，测试集大小: 30

离散化特征(用于ID3算法)...

使用ID3算法构建决策树...
可视化ID3决策树...
ID3决策树已保存为&#39;id3_tree.png&#39;

评估ID3决策树...
ID3决策树在测试集上的准确率: 0.9333

使用C4.5算法构建决策树...
可视化C4.5决策树...
D:\coding\简简单单挖掘个数据\exp03\main.py:440: ParserWarning: Falling back to the &#39;python&#39; engine because the separator encoded in utf-8 is &gt; 1 char long, and the &#39;c&#39; engine does not support such separators; you can avoid this warning by specifying engine=&#39;python&#39;.
  watermelon_data = pd.read_csv(&#39;./data/watermelon.txt&#39;, sep=&#39;，&#39;, encoding=&#39;utf-8&#39;)
C4.5决策树已保存为&#39;c45_tree.png&#39;

评估C4.5决策树...
C4.5决策树在测试集上的准确率: 1.0000

处理西瓜数据集...
成功加载西瓜数据集: 17行 x 7列
数据列名: [&#39;色泽&#39;, &#39;根蒂&#39;, &#39;敲声&#39;, &#39;纹理&#39;, &#39;脐部&#39;, &#39;触感&#39;, &#39;质量&#39;]
目标变量列名为：质量
目标变量分布:
质量
否    9
是    8
Name: count, dtype: int64
为西瓜数据集构建决策树...
可视化西瓜数据集决策树...
西瓜数据集决策树已保存为&#39;watermelon_tree.png&#39;

进程已结束，退出代码为 0
</code></pre><h5 id="图片输出">图片输出</h5>
<h6 id="id3_tree">id3_tree</h6>
<p><img src="9e319a5fcfa965811720fc73e80afe2a_MD5.webp" alt=""></p>
<h6 id="c45_tree">c45_tree</h6>
<p><img src="a43f05b09fcbf2246c907611f901a632_MD5.webp" alt=""></p>
<h6 id="西瓜数据集">西瓜数据集</h6>
<blockquote>
<p>不支持中文我是真没办法，真懒得改了 O。o</p>
</blockquote>
<p><img src="4e7f605773323dc9305b55e57a81d4ee_MD5.webp" alt=""></p>
<h3 id="实验体会">实验体会</h3>
<p>通过本次实验，我深入理解了决策树算法，掌握了ID3和C4.5的原理与实现。使用Iris和西瓜数据集，我学会了数据预处理，包括数据集划分和特征离散化，尤其为ID3准备离散数据。模型构建中，我实现了两种算法，并通过Graphviz可视化决策树，直观理解其工作原理。评估时，C4.5在处理连续特征时表现更优。实验中，面对特征离散化和数据问题的挑战，我通过调试解决，提升了问题解决能力。未来，我计划探索剪枝技术和缺失值处理，以优化模型性能。这次实验不仅让我掌握决策树算法，还增强了编程和分析能力，为后续学习和工作奠定了基础。</p>
<hr>
<h1 id="4-实验四聚类算法">4. 实验四：聚类算法</h1>
<h3 id="实验要求-3">实验要求</h3>
<table>
  <thead>
      <tr>
          <th>实验目的：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、理解聚类算法的原理；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、能够使用聚类算法处理具体问题；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、能够使用Python语言实现聚类算法。</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>实验内容：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、 读取数据文件Wholesale customers data.csv，使用手肘法（Elbow Method）确定K值，输出随着K值变化SSE随之变化的图片；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、 根据1中确定的K值，运用K-Means算法对数据集进行聚类，参数设定：最大迭代次数为100，距离函数为欧式距离；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、 更改参数设定：最大迭代次数为500，距离函数为欧式距离；<!-- raw HTML omitted --><!-- raw HTML omitted -->4、 更改参数设定：最大迭代次数为1000，距离函数为欧式距离；<!-- raw HTML omitted --><!-- raw HTML omitted -->5、 将上述三次聚类结果用TSNE降维并进行展示；<!-- raw HTML omitted --><!-- raw HTML omitted -->6、 对比三次结果并加以分析（如使用概率密度函数图，分析聚类结果的不同特征）；<!-- raw HTML omitted --><!-- raw HTML omitted -->7、 尝试使用不同的随机种子，最大迭代次数为500，距离函数为欧式距离，通过TSNE降维与3降维结果对比，观察聚类结果是否发生变化；<!-- raw HTML omitted --><!-- raw HTML omitted -->8、 使用轮廓系数法再次确定K值，输出图片，对比与1中确定的K值是否一致，如果不一致使用新的K值进行聚类，并通过TSNE降维展示聚类结果； <!-- raw HTML omitted --><!-- raw HTML omitted -->9、 将上述实验内容的核心代码及实验结果截图放到“实验过程及分析”中。</td>
      </tr>
  </tbody>
</table>
<h3 id="实验过程以及分析-3">实验过程以及分析</h3>
<h4 id="1-利用手肘法elbow-method确定最优-k-值">1. 利用手肘法（Elbow Method）确定最优 K 值</h4>
<h5 id="实验描述-5">实验描述</h5>
<p>1、 读取数据文件Wholesale customers data.csv，使用手肘法（Elbow Method）确定K值，输出随着K值变化SSE随之变化的图片；</p>
<h5 id="实验分析">实验分析</h5>
<p>目的在于通过簇内平方和（SSE）随 K 值变化的趋势，寻找“SSE–K 曲线”上的拐点。该拐点对应的 K 通常能在保持较小 SSE 的同时避免过度划分，从而较好平衡模型复杂度与数据拟合度。</p>
<h5 id="代码实现-8">代码实现</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">elbow_method</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k_range</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;手肘法：绘制不同 K 值下的 SSE 曲线&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">sse</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_range</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">km</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s1">&#39;k-means++&#39;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">km</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">sse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">km</span><span class="o">.</span><span class="n">inertia_</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k_range</span><span class="p">,</span> <span class="n">sse</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;簇数 K&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;簇内 SSE&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Elbow Method&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sse</span>
</span></span></code></pre></div><h4 id="24-不同迭代次数下的-k-means-聚类">2–4. 不同迭代次数下的 K-Means 聚类</h4>
<h5 id="实验描述-6">实验描述</h5>
<ol>
<li>根据1中确定的K值，运用K-Means算法对数据集进行聚类，参数设定：最大迭代次数为100，距离函数为欧式距离；</li>
<li>更改参数设定：最大迭代次数为500，距离函数为欧式距离；</li>
<li>更改参数设定：最大迭代次数为1000，距离函数为欧式距离；</li>
</ol>
<h5 id="实验分析-1">实验分析</h5>
<ul>
<li>设置最大迭代次数为 100、500、1000，考察算法收敛速度与终态稳定性。</li>
<li>预期：100 次迭代可能未完全收敛，SSE 较高且聚类结果在边缘样本上存在漂移；500 次可达到收敛；1000 次则与 500 次结果基本一致，表明 500 次足以保证稳定。</li>
</ul>
<h5 id="代码实现-9">代码实现</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">### 2-4. 不同最大迭代次数的聚类对比  </span>
</span></span><span class="line"><span class="cl"><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>  
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">max_iter</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]:</span>  
</span></span><span class="line"><span class="cl">    <span class="n">km</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">run_kmeans</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">k_opt</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">results</span><span class="p">[</span><span class="n">max_iter</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Max iter=</span><span class="si">{</span><span class="n">max_iter</span><span class="si">}</span><span class="s1">, SSE=</span><span class="si">{</span><span class="n">km</span><span class="o">.</span><span class="n">inertia_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run_kmeans</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;执行 K-Means 聚类并返回模型与标签&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">km</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s1">&#39;k-means++&#39;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">labels</span> <span class="o">=</span> <span class="n">km</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">km</span><span class="p">,</span> <span class="n">labels</span>
</span></span></code></pre></div><h4 id="5-将三次聚类结果用-t-sne-降维并可视化">5. 将三次聚类结果用 t-SNE 降维并可视化</h4>
<h5 id="实验描述-7">实验描述</h5>
<p>将上述三次聚类结果用TSNE降维并进行展示；</p>
<h5 id="实验分析-2">实验分析</h5>
<p>通过 t-SNE 将高维标准化后的客户特征映射至二维平面，使用不同颜色区分簇标签，可直观呈现各簇的分布与分离度，从视觉上验证迭代次数对簇形状与边界的影响。</p>
<h5 id="代码实现-10">代码实现</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">silhouette_method</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k_range</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;轮廓系数法：绘制不同 K 值下的平均轮廓系数&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## 跳过 k = 1，因为 silhouette_score 仅在 2 &lt;= k &lt;= n_samples-1 有效  </span>
</span></span><span class="line"><span class="cl">    <span class="n">sil_scores</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">    <span class="n">sil_k</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_range</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>  
</span></span><span class="line"><span class="cl">        <span class="n">km</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s1">&#39;k-means++&#39;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">labels</span> <span class="o">=</span> <span class="n">km</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">score</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">sil_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">sil_k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sil_k</span><span class="p">,</span> <span class="n">sil_scores</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;簇数 K&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;平均轮廓系数&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Silhouette Method&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sil_k</span><span class="p">,</span> <span class="n">sil_scores</span>
</span></span></code></pre></div><h4 id="6-对比三次结果并分析">6. 对比三次结果并分析</h4>
<h5 id="实验描述-8">实验描述</h5>
<p>对比三次结果并加以分析（如使用概率密度函数图，分析聚类结果的不同特征）；</p>
<h5 id="实验分析-3">实验分析</h5>
<p>对聚类结果中的关键变量（如 Fresh、Milk、Grocery）分别绘制核密度估计曲线：</p>
<ul>
<li>对比不同迭代次数下，同一簇内各特征的分布差异。</li>
<li>有助于定量评估算法是否因迭代不足导致簇内样本分布偏移或簇间重叠加剧。</li>
</ul>
<h5 id="代码实现-11">代码实现</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">plot_tsne</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;使用 t-SNE 降维并可视化聚类结果&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">emb</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">emb</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">emb</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">hue</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;tab10&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><h4 id="7-不同随机种子下的聚类稳定性检验">7. 不同随机种子下的聚类稳定性检验</h4>
<h5 id="实验描述-9">实验描述</h5>
<p>尝试使用不同的随机种子，最大迭代次数为500，距离函数为欧式距离，通过TSNE降维与3降维结果对比，观察聚类结果是否发生变化；</p>
<h5 id="实验分析-4">实验分析</h5>
<p>在固定迭代次数（500 次）与距离度量（欧式距离）条件下，改变 <code>random_state</code>，分析不同初始质心对最终簇划分的影响。若整体簇形一致，则说明算法对初始化具备鲁棒性；若存在明显差异，则需在实际应用中多次试验并选取最优结果。</p>
<h5 id="代码实现-12">代码实现</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">### 7. 不同随机种子下聚类稳定性检验（max_iter=500）  </span>
</span></span><span class="line"><span class="cl"><span class="n">seeds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">123</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="n">km</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">run_kmeans</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">k_opt</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plot_tsne</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;随机种子=</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h4 id="8-使用轮廓系数法silhouette-method重新确定-k-值">8. 使用轮廓系数法（Silhouette Method）重新确定 K 值</h4>
<h5 id="实验描述-10">实验描述</h5>
<p>使用轮廓系数法再次确定K值，输出图片，对比与1中确定的K值是否一致，如果不一致使用新的K值进行聚类，并通过TSNE降维展示聚类结果；</p>
<h5 id="实验分析-5">实验分析</h5>
<ul>
<li>计算 2 ≤ K ≤ 10 范围内的平均轮廓系数，选取最高值对应的 K。</li>
<li>将该 K 重新用于 K-Means，并结合 t-SNE 可视化与手肘法结果对比，验证不同度量方法对最优簇数判断的一致性与差异。</li>
</ul>
<h5 id="代码实现-13">代码实现</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">plot_feature_pdfs</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;绘制各簇在指定特征上的核密度估计图&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">df_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">features_all</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">df_scaled</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_scaled</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1"> - 特征 </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s1"> 核密度估计&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><h4 id="主函数实验流程-1">主函数（实验流程）</h4>
<h5 id="代码实现-14">代码实现</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## 数据路径设置  </span>
</span></span><span class="line"><span class="cl">    <span class="n">data_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;Wholesale customers data.csv&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">df</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 选择数值特征并标准化  </span>
</span></span><span class="line"><span class="cl">    <span class="n">df_features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">features_all</span>  
</span></span><span class="line"><span class="cl">    <span class="n">features_all</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_features</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">df_features</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 1. 手肘法确定 K    k_range = range(1, 11)  </span>
</span></span><span class="line"><span class="cl">    <span class="n">sse</span> <span class="o">=</span> <span class="n">elbow_method</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">k_range</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;elbow.png&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## TODO: 根据图像拐点设定最优 K 值  </span>
</span></span><span class="line"><span class="cl">    <span class="n">k_opt</span> <span class="o">=</span> <span class="mi">3</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 2-4. 不同最大迭代次数的聚类对比  </span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">max_iter</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">km</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">run_kmeans</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">k_opt</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="n">max_iter</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Max iter=</span><span class="si">{</span><span class="n">max_iter</span><span class="si">}</span><span class="s1">, SSE=</span><span class="si">{</span><span class="n">km</span><span class="o">.</span><span class="n">inertia_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 5. t-SNE 可视化三次聚类结果  </span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">        <span class="n">plot_tsne</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;KMeans (K=</span><span class="si">{</span><span class="n">k_opt</span><span class="si">}</span><span class="s1">, max_iter=</span><span class="si">{</span><span class="n">max_iter</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 6. 使用核密度估计对比特征分布  </span>
</span></span><span class="line"><span class="cl">    <span class="n">key_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Fresh&#39;</span><span class="p">,</span> <span class="s1">&#39;Milk&#39;</span><span class="p">,</span> <span class="s1">&#39;Grocery&#39;</span><span class="p">]</span>  <span class="c1">## 可根据需求调整  </span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">        <span class="n">plot_feature_pdfs</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">key_features</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;迭代</span><span class="si">{</span><span class="n">max_iter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 7. 不同随机种子下聚类稳定性检验（max_iter=500）  </span>
</span></span><span class="line"><span class="cl">    <span class="n">seeds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">123</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">seeds</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">km</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">run_kmeans</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">k_opt</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">plot_tsne</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;随机种子=</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 8. 轮廓系数法确定 K 并可视化  </span>
</span></span><span class="line"><span class="cl">    <span class="n">sil_k</span><span class="p">,</span> <span class="n">sil_scores</span> <span class="o">=</span> <span class="n">silhouette_method</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">k_range</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;silhouette.png&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## 选取轮廓系数最大的 K    k_opt2 = sil_k[np.argmax(sil_scores)]  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;轮廓系数法最优 K=</span><span class="si">{</span><span class="n">k_opt2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">km2</span><span class="p">,</span> <span class="n">labels2</span> <span class="o">=</span> <span class="n">run_kmeans</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">k_opt2</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plot_tsne</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">labels2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Silhouette 确定 K=</span><span class="si">{</span><span class="n">k_opt2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h5 id="实验结果-1">实验结果</h5>
<h6 id="终端输出-2">终端输出</h6>
<pre tabindex="0"><code>C:\Users\19065\miniconda3\python.exe D:\coding\简简单单挖掘个数据\exp04\main.py 
Max iter=100, SSE=1644.0598512347565
Max iter=500, SSE=1644.0598512347565
Max iter=1000, SSE=1644.0598512347565
轮廓系数法最优 K=3

进程已结束，退出代码为 0
</code></pre><h6 id="图片输出-1">图片输出</h6>
<p><img src="034eab332ac63444f97e3639b60b6dd4_MD5.webp" alt=""></p>
<p><img src="034eab332ac63444f97e3639b60b6dd4_MD5_1.webp" alt=""></p>
<p><img src="08ec3530008c568b58a39995b61b45c3_MD5.webp" alt=""></p>
<p><img src="6877d82b7492faf46169505641a7dcac_MD5.webp" alt=""></p>
<p><img src="4c9024a7e2a0bc53c9874453f78c117c_MD5.webp" alt=""></p>
<p><img src="ee6dc468d6a00b9dda4ce1dcc2aa297c_MD5.webp" alt=""></p>
<p><img src="44dba3654a4f6cee0a2e2f29206310c0_MD5.webp" alt=""></p>
<p><img src="8ad99b5800d45b804758b97e11d173d4_MD5.webp" alt=""></p>
<p><img src="566956b40972218f0649c98e0ae28b1a_MD5.webp" alt=""></p>
<p><img src="7628a4a5f0bd465b5069def1572e7c05_MD5.webp" alt=""></p>
<p><img src="edbe4c6082ea2a7573121b62354daa05_MD5.webp" alt=""></p>
<p><img src="d55d138f3bbe57ccbc4988f7191afef4_MD5.webp" alt=""></p>
<p><img src="c5427175200b027309fe9c95387096af_MD5.webp" alt=""></p>
<p><img src="95f264ce59c6529b5685ca12c040d0bb_MD5.webp" alt=""></p>
<p><img src="78e7550c53562cbb5f663837deae4c27_MD5.webp" alt=""></p>
<p><img src="0266f064f8f6bd8a46fa621be4b9bae3_MD5.webp" alt=""></p>
<p><img src="427100785b973e274e8e66ec012c62aa_MD5.webp" alt=""></p>
<p><img src="bcd2743502f8bac40d7ec2efe043197c_MD5.webp" alt=""></p>
<p><img src="fedf2a9c089a0c2e23197ea44a79c31e_MD5.webp" alt=""></p>
<p><img src="bcd2743502f8bac40d7ec2efe043197c_MD5_1.webp" alt=""></p>
<h3 id="实验体会与总结-2">实验体会与总结</h3>
<p>本次实验通过手肘法和轮廓系数法确定最优簇数，并对比了不同最大迭代次数（100、500、1000）以及多组随机种子对 K-Means 聚类结果的影响。结果表明，当迭代次数较低时（100 次）簇内 SSE 较高且聚类边界不稳定；达到 500 次后，SSE 基本收敛，簇划分趋于稳定；1000 次与 500 次结果高度一致，说明 500 次已足够。不同随机种子会导致少量样本在边缘簇间漂移，但整体簇结构差异不大，说明算法对初始化具有一定鲁棒性。t-SNE 可视化直观地展示了各簇的分布情况，而核密度估计则进一步揭示了关键特征（如 Fresh、Milk、Grocery）在不同簇中的分布差异。综合来看，多种方法的结合不仅提高了聚类结果的可解释性，也为实际应用中的参数选择提供了科学依据。</p>
<hr>
<h1 id="5-实验五关联规则算法">5. 实验五：关联规则算法</h1>
<h3 id="实验内容">实验内容</h3>
<table>
  <thead>
      <tr>
          <th>实验目的：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、理解关联规则算法的原理；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、能够使用关联规则算法处理具体问题；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、能够使用Python语言实现关联规则算法。</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>实验内容：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、 根据给定的数据集GoodsOrder.csv，计算销量排名前8的商品销量及其占比，并绘制条形图显示这8种商品的具体销量（在条形图里要显示具体的销售量及占比）；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、 根据给定的数据集GoodsOrder.csv和GoodsTypes.csv，对商品进行归类，并计算归类之后的各类商品的销量及占比，绘制饼状图进行显示（在饼状图里要显示具体的商品类别及占比）；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、 根据给定的数据集GoodsOrder.csv，对原始数据进行数据预处理，转换数据形式，使之符合Apriori关联规则算法要求；<!-- raw HTML omitted --><!-- raw HTML omitted -->4、 在上述数据的基础上，采用Apriori关联规则算法，设置最小支持度为0.2，最小可信度为0.3，输出求得的关联规则；<!-- raw HTML omitted --><!-- raw HTML omitted -->5、 修改参数：最小支持度为0.02，最小可信度为0.35，输出求得的关联规则，<!-- raw HTML omitted --><!-- raw HTML omitted -->6、 结合实际业务，对步骤5输出的关联规则进行分析并给出销售建议；<!-- raw HTML omitted --><!-- raw HTML omitted -->7、 提升度（Lift）是什么指标？它与关联规则有和联系？<!-- raw HTML omitted --><!-- raw HTML omitted -->8、 拓展题：用FP-Tree算法生成关联规则，并分析Apriori算法与FP-Tree算法的异同；<!-- raw HTML omitted --><!-- raw HTML omitted -->9、 将上述实验内容的核心代码及实验结果截图放到“实验过程及分析”中。</td>
      </tr>
  </tbody>
</table>
<h3 id="实验过程及分析">实验过程及分析</h3>
<h4 id="实验分析-6">实验分析</h4>
<h5 id="1-计算销量排名前8的商品销量及其占比并绘制条形图"><strong>1. 计算销量排名前8的商品销量及其占比，并绘制条形图</strong></h5>
<p>读取 <code>GoodsOrder.csv</code> 后，统计各商品的总销量，排序后取前8名，计算它们的占比，并绘制带数值标注的条形图。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 读取数据</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&#34;GoodsOrder.csv&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 计算各商品销量</span>
</span></span><span class="line"><span class="cl"><span class="n">top_goods</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;GoodsName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">top_total</span> <span class="o">=</span> <span class="n">top_goods</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">top_goods_ratio</span> <span class="o">=</span> <span class="n">top_goods</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 可视化</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">bars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">top_goods</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">top_goods</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">top_goods</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">top_goods_ratio</span><span class="o">.</span><span class="n">values</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;销量排名前8商品销量及占比&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;销量&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><h5 id="2-商品归类后统计销量及占比绘制饼状图"><strong>2. 商品归类后统计销量及占比，绘制饼状图</strong></h5>
<p>将 <code>GoodsOrder.csv</code> 与 <code>GoodsTypes.csv</code> 通过 <code>GoodsID</code> 关联，对每类商品销量进行统计，并绘制饼状图展示占比。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">### 读取商品分类</span>
</span></span><span class="line"><span class="cl"><span class="n">types</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&#34;GoodsTypes.csv&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 合并数据</span>
</span></span><span class="line"><span class="cl"><span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;GoodsID&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 统计类别销量</span>
</span></span><span class="line"><span class="cl"><span class="n">type_sales</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;GoodsType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">type_ratio</span> <span class="o">=</span> <span class="n">type_sales</span> <span class="o">/</span> <span class="n">type_sales</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 绘制饼图</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">type_sales</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">)&#34;</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">type_sales</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">type_ratio</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">        <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">140</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;各类商品销量及占比&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><h5 id="3-数据预处理转换为apriori算法输入格式"><strong>3. 数据预处理，转换为Apriori算法输入格式</strong></h5>
<p>将每笔订单转换为一个商品集合，用于后续的关联规则分析。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">### 假设每一条记录代表一件商品的购买，按订单ID聚合商品</span>
</span></span><span class="line"><span class="cl"><span class="n">transactions</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;OrderID&#39;</span><span class="p">)[</span><span class="s1">&#39;GoodsName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 保存为列表格式以供mlxtend使用</span>
</span></span><span class="line"><span class="cl"><span class="n">transactions_list</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span></code></pre></div><h5 id="4-使用apriori算法支持度02可信度03输出关联规则"><strong>4. 使用Apriori算法（支持度=0.2，可信度=0.3）输出关联规则</strong></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">mlxtend.preprocessing</span> <span class="kn">import</span> <span class="n">TransactionEncoder</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">mlxtend.frequent_patterns</span> <span class="kn">import</span> <span class="n">apriori</span><span class="p">,</span> <span class="n">association_rules</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 编码</span>
</span></span><span class="line"><span class="cl"><span class="n">te</span> <span class="o">=</span> <span class="n">TransactionEncoder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">te_ary</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">transactions_list</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transactions_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df_encoded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">te_ary</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">te</span><span class="o">.</span><span class="n">columns_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### Apriori</span>
</span></span><span class="line"><span class="cl"><span class="n">frequent_itemsets</span> <span class="o">=</span> <span class="n">apriori</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">use_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rules</span> <span class="o">=</span> <span class="n">association_rules</span><span class="p">(</span><span class="n">frequent_itemsets</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="n">min_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">rules</span><span class="p">[[</span><span class="s1">&#39;antecedents&#39;</span><span class="p">,</span> <span class="s1">&#39;consequents&#39;</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;lift&#39;</span><span class="p">]])</span>
</span></span></code></pre></div><h5 id="5-修改apriori参数支持度002可信度035输出关联规则"><strong>5. 修改Apriori参数（支持度=0.02，可信度=0.35）输出关联规则</strong></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">### Apriori with new parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">frequent_itemsets2</span> <span class="o">=</span> <span class="n">apriori</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">use_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rules2</span> <span class="o">=</span> <span class="n">association_rules</span><span class="p">(</span><span class="n">frequent_itemsets2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="n">min_threshold</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">rules2</span><span class="p">[[</span><span class="s1">&#39;antecedents&#39;</span><span class="p">,</span> <span class="s1">&#39;consequents&#39;</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;lift&#39;</span><span class="p">]])</span>
</span></span></code></pre></div><h5 id="6-分析关联规则并给出销售建议"><strong>6. 分析关联规则并给出销售建议</strong></h5>
<ul>
<li><strong>业务洞察</strong>：
<ul>
<li>规则表明，购买「面包」的顾客有较高概率也会购买「牛奶」。</li>
<li>若提升度（Lift）&gt;1，说明此规则强于随机购买，存在正相关。</li>
</ul>
</li>
<li><strong>销售建议</strong>：
<ul>
<li>可将「面包」和「牛奶」搭配做组合促销或在货架上邻近摆放。</li>
<li>也可以通过推荐系统在顾客选购「面包」时推荐「牛奶」。</li>
</ul>
</li>
</ul>
<h5 id="7-提升度lift指标及其意义"><strong>7. 提升度（Lift）指标及其意义</strong></h5>
<ul>
<li><strong>定义</strong>：
$Lift(X→Y)=P(X∪Y)P(X)⋅P(Y)\text{Lift}(X \rightarrow Y) = \frac{P(X \cup Y)}{P(X) \cdot P(Y)}$
或等价于：
$Lift=Confidence(X→Y)P(Y)\text{Lift} = \frac{\text{Confidence}(X \rightarrow Y)}{P(Y)}$</li>
<li><strong>含义</strong>：
<ul>
<li>Lift &gt; 1：X 和 Y 正相关，规则有价值。</li>
<li>Lift = 1：X 和 Y 独立，无关联。</li>
<li>Lift &lt; 1：X 和 Y 负相关，规则不建议采纳。</li>
</ul>
</li>
</ul>
<h5 id="8-拓展题fp-tree算法生成关联规则比较其与apriori的异同"><strong>8. 拓展题：FP-Tree算法生成关联规则，比较其与Apriori的异同</strong></h5>
<p><strong>使用FP-Growth算法</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">mlxtend.frequent_patterns</span> <span class="kn">import</span> <span class="n">fpgrowth</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 使用FP-Growth代替Apriori</span>
</span></span><span class="line"><span class="cl"><span class="n">frequent_itemsets_fp</span> <span class="o">=</span> <span class="n">fpgrowth</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">use_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rules_fp</span> <span class="o">=</span> <span class="n">association_rules</span><span class="p">(</span><span class="n">frequent_itemsets_fp</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="n">min_threshold</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">rules_fp</span><span class="p">[[</span><span class="s1">&#39;antecedents&#39;</span><span class="p">,</span> <span class="s1">&#39;consequents&#39;</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;lift&#39;</span><span class="p">]])</span>
</span></span></code></pre></div><p><strong>比较分析</strong>：</p>
<table>
  <thead>
      <tr>
          <th>特性</th>
          <th>Apriori</th>
          <th>FP-Growth</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>原理</td>
          <td>基于候选集的逐层扩展</td>
          <td>构建压缩的频繁模式树（FP-Tree）</td>
      </tr>
      <tr>
          <td>计算效率</td>
          <td>较低（需多次扫描数据集）</td>
          <td>更高（仅需两次扫描）</td>
      </tr>
      <tr>
          <td>内存消耗</td>
          <td>较低</td>
          <td>可能较高（需构建树结构）</td>
      </tr>
      <tr>
          <td>适用场景</td>
          <td>小规模数据</td>
          <td>大规模、稠密数据集</td>
      </tr>
  </tbody>
</table>
<h4 id="实验结果-2">实验结果</h4>
<h5 id="终端输出-3">终端输出</h5>
<pre tabindex="0"><code>C:\Users\19065\miniconda3\python.exe D:\coding\简简单单挖掘个数据\exp05\main.py 
数据读取完成，开始分析...
订单数据形状: (43367, 2)
商品类型数据形状: (169, 2)

订单数据前5行:
   id  Goods
0   1  柑橘类水果
1   1   人造黄油
2   1    即食汤
3   1  半成品面包
4   2     咖啡

商品类型数据前5行:
   Goods Types
0     白饭    熟食
1     白酒  酒精饮料
2    白兰地  酒精饮料
3    白面包    西点
4  半成品面包    西点

调整后的订单数据结构:
[&#39;TransactionID&#39;, &#39;Goods&#39;, &#39;OrderCount&#39;]

调整后的商品类型数据结构:
[&#39;Goods&#39;, &#39;Type&#39;]
开始商品销售数据分析与关联规则挖掘...


任务1: 计算销量排名前8的商品销量及其占比

销量排名前8的商品:
   Goods  OrderCount  Percentage
0   全脂牛奶        2513    5.794729
1   其他蔬菜        1903    4.388129
2    面包卷        1809    4.171375
3     苏打        1715    3.954620
4     酸奶        1372    3.163696
5    瓶装水        1087    2.506514
6  根茎类蔬菜        1072    2.471926
7   热带水果        1032    2.379690

任务2: 对商品进行归类，计算各类商品销量及占比
警告: 有 82 条记录的商品没有分类信息

各类商品销量及占比:
     Type  OrderCount  Percentage
0   非酒精饮料        7594   17.511011
1      西点        7192   16.584039
2      果蔬        7146   16.477967
3    米粮调料        5185   11.956096
4      百货        5141   11.854636
5      肉类        4870   11.229737
6    酒精饮料        2287    5.273595
7     食品类        1870    4.312034
8      零食        1459    3.364309
9      熟食         541    1.247492
10    未分类          82    0.189084

任务3: 数据预处理，转换为关联规则算法所需的格式

共有 9835 个交易记录
前5个交易记录示例:
交易 1: [&#39;柑橘类水果&#39;, &#39;人造黄油&#39;, &#39;即食汤&#39;, &#39;半成品面包&#39;]
交易 2: [&#39;咖啡&#39;, &#39;热带水果&#39;, &#39;酸奶&#39;]
交易 3: [&#39;全脂牛奶&#39;]
交易 4: [&#39;奶油乳酪&#39;, &#39;肉泥&#39;, &#39;仁果类水果&#39;, &#39;酸奶&#39;]
交易 5: [&#39;炼乳&#39;, &#39;长面包&#39;, &#39;其他蔬菜&#39;, &#39;全脂牛奶&#39;]

转换后的二进制矩阵(前5行5列):
   一般清洁剂   一般肉类   一般饮料   人造黄油  仁果类水果
0  False  False  False   True  False
1  False  False  False  False  False
2  False  False  False  False  False
3  False  False  False  False   True
4  False  False  False  False  False

使用初始参数: 最小支持度=0.2, 最小可信度=0.3

任务4: Apriori算法 (min_support=0.2, min_confidence=0.3)

频繁项集:
    support itemsets
0  0.255516   (全脂牛奶)
没有找到满足最小可信度的关联规则，请尝试降低最小可信度

使用调整后参数: 最小支持度=0.02, 最小可信度=0.35

任务4: Apriori算法 (min_support=0.02, min_confidence=0.35)

频繁项集:
    support itemsets
0  0.025826   (一般肉类)
1  0.026029   (一般饮料)
2  0.058566   (人造黄油)
3  0.075648  (仁果类水果)
4  0.255516   (全脂牛奶)

关联规则(前5条):
    antecedents consequents   support  confidence      lift
25     其他蔬菜, 酸奶        全脂牛奶  0.022267    0.512881  2.007235
15           黄油        全脂牛奶  0.027555    0.497248  1.946053
4            凝乳        全脂牛奶  0.026131    0.490458  1.919481
23  其他蔬菜, 根茎类蔬菜        全脂牛奶  0.023183    0.489270  1.914833
22  全脂牛奶, 根茎类蔬菜        其他蔬菜  0.023183    0.474012  2.449770

任务6: 关联规则分析及销售建议

提升度最高的10条规则:
    antecedents consequents   support  confidence      lift
22  全脂牛奶, 根茎类蔬菜        其他蔬菜  0.023183    0.474012  2.449770
18        根茎类蔬菜        其他蔬菜  0.047382    0.434701  2.246605
20          酸奶油        其他蔬菜  0.028876    0.402837  2.081924
24     全脂牛奶, 酸奶        其他蔬菜  0.022267    0.397459  2.054131
25     其他蔬菜, 酸奶        全脂牛奶  0.022267    0.512881  2.007235
15           黄油        全脂牛奶  0.027555    0.497248  1.946053
19           猪肉        其他蔬菜  0.021657    0.375661  1.941476
4            凝乳        全脂牛奶  0.026131    0.490458  1.919481
23  其他蔬菜, 根茎类蔬菜        全脂牛奶  0.023183    0.489270  1.914833
21           黄油        其他蔬菜  0.020031    0.361468  1.868122

销售建议:
1. 捆绑销售策略:
   - 将 全脂牛奶, 根茎类蔬菜 与 其他蔬菜 放在一起销售，可能会提高销量
   - 将 根茎类蔬菜 与 其他蔬菜 放在一起销售，可能会提高销量
   - 将 酸奶油 与 其他蔬菜 放在一起销售，可能会提高销量

2. 产品布局:
   - 在商店中将 全脂牛奶, 酸奶 与 其他蔬菜 放在相邻位置
   - 在商店中将 其他蔬菜, 酸奶 与 全脂牛奶 放在相邻位置
   - 在商店中将 黄油 与 全脂牛奶 放在相邻位置

3. 促销活动:
   - 购买 猪肉 时，可以给予 其他蔬菜 折扣
   - 购买 凝乳 时，可以给予 全脂牛奶 折扣
   - 购买 其他蔬菜, 根茎类蔬菜 时，可以给予 全脂牛奶 折扣

任务7: 提升度(Lift)指标解释

提升度(Lift)是衡量关联规则有效性的重要指标，它表示同时购买A和B的概率与独立购买A和B的概率的比值。

提升度的计算公式为: Lift(A→B) = P(B|A) / P(B) = Confidence(A→B) / Support(B)

提升度与关联规则的关系:
1. 提升度 &gt; 1: 表示A的出现对B的出现有正向影响，即A和B是正相关的。提升度越高，关联性越强。
2. 提升度 = 1: 表示A和B相互独立，即A的出现对B的出现没有影响。
3. 提升度 &lt; 1: 表示A的出现对B的出现有负向影响，即A和B是负相关的。

在商业分析中，通常关注提升度大于1的规则，因为这些规则表明两种商品之间存在真正的关联性，
可以用于指导产品布局、捆绑销售、促销活动等营销策略的制定。
    

任务8: FP-Tree算法与Apriori算法比较

FP-Growth算法 (min_support=0.02):

FP-Growth找到的频繁项集数量: 122
FP-Growth找到的关联规则数量: 26
FP-Growth执行时间: 1.5725 秒

使用相同参数的Apriori算法:
Apriori找到的频繁项集数量: 122
Apriori找到的关联规则数量: 26
Apriori执行时间: 0.0882 秒

Apriori算法与FP-Tree算法的异同:

相同点:
1. 目的相同: 两种算法都用于发现数据中的频繁项集和关联规则。
2. 最终结果相同: 在相同的参数设置下，两种算法发现的频繁项集和关联规则应该是一致的。
3. 都遵循支持度和置信度阈值: 两种算法都使用支持度和置信度作为筛选规则的标准。

不同点:
1. 算法原理:
   - Apriori: 使用&#34;先验性质&#34;，即如果一个项集是频繁的，则它的所有子集也是频繁的。采用广度优先搜索策略。
   - FP-Tree: 使用紧凑的树结构存储频繁项信息，避免了多次扫描数据库，采用深度优先搜索策略。

2. 性能效率:
   - Apriori: 在处理大数据集时，可能需要生成大量的候选项集，导致算法效率较低。
   - FP-Tree: 通常比Apriori更高效，尤其是在处理大规模数据集时，因为它避免了生成候选项集的过程。

3. 内存使用:
   - Apriori: 需要存储所有候选项集，可能占用较大内存。
   - FP-Tree: 使用紧凑的树结构，内存使用通常更高效。

4. 应用场景:
   - Apriori: 适合项目数量少、事务数量适中的情况。
   - FP-Tree: 更适合处理大规模数据集和高维数据。

总结: FP-Tree算法通常比Apriori算法更高效，特别是在处理大规模数据集时。
但Apriori算法概念简单，易于实现和理解，在小型数据集上仍有其应用价值。
    

分析完成！所有图表已保存。

进程已结束，退出代码为 0
</code></pre><h5 id="实验图表">实验图表</h5>
<p><img src="f2e8fff8ce88cfd960c654c118ebc3f1_MD5.webp" alt=""></p>
<p><img src="adf9ea87d039aae97da7b3b3ac33750b_MD5.webp" alt=""></p>
<h4 id="核心代码">核心代码</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">mlxtend.frequent_patterns</span> <span class="kn">import</span> <span class="n">apriori</span><span class="p">,</span> <span class="n">association_rules</span><span class="p">,</span> <span class="n">fpgrowth</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">mlxtend.preprocessing</span> <span class="kn">import</span> <span class="n">TransactionEncoder</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">warnings</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 设置中文显示  </span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>  <span class="c1">## 用来正常显示中文标签  </span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">## 用来正常显示负号  </span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 数据路径  </span>
</span></span><span class="line"><span class="cl"><span class="n">data_path</span> <span class="o">=</span> <span class="s1">&#39;./data&#39;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 读取数据  </span>
</span></span><span class="line"><span class="cl"><span class="n">goods_order</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;GoodsOrder.csv&#39;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"><span class="n">goods_types</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;GoodsTypes.csv&#39;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;数据读取完成，开始分析...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;订单数据形状: </span><span class="si">{</span><span class="n">goods_order</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;商品类型数据形状: </span><span class="si">{</span><span class="n">goods_types</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 显示数据前几行  </span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">订单数据前5行:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">goods_order</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">商品类型数据前5行:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">goods_types</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 根据示例，确认数据结构  </span>
</span></span><span class="line"><span class="cl"><span class="c1">### GoodsOrder.csv格式: id,Goods (例如: 1,柑橘类水果)  </span>
</span></span><span class="line"><span class="cl"><span class="c1">### 确保goods_order包含正确的列名  </span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="s1">&#39;TransactionID&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">goods_order</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">goods_order</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="n">goods_order</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;TransactionID&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="s1">&#39;OrderCount&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">goods_order</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## 假设每行代表一次购买，数量为1  </span>
</span></span><span class="line"><span class="cl">    <span class="n">goods_order</span><span class="p">[</span><span class="s1">&#39;OrderCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### GoodsTypes.csv格式: Goods,Types (例如: 白饭,熟食)  </span>
</span></span><span class="line"><span class="cl"><span class="c1">### 确保goods_types包含正确的列名  </span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="s1">&#39;Type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">goods_types</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;Types&#39;</span> <span class="ow">in</span> <span class="n">goods_types</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="n">goods_types</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Types&#39;</span><span class="p">:</span> <span class="s1">&#39;Type&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">调整后的订单数据结构:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">goods_order</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">调整后的商品类型数据结构:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">goods_types</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 1. 计算销量排名前8的商品销量及其占比，并绘制条形图  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">top_goods_analysis</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">任务1: 计算销量排名前8的商品销量及其占比&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 计算每种商品的销量（频次）  </span>
</span></span><span class="line"><span class="cl">    <span class="n">goods_sales</span> <span class="o">=</span> <span class="n">goods_order</span><span class="p">[</span><span class="s1">&#39;Goods&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">goods_sales</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Goods&#39;</span><span class="p">,</span> <span class="s1">&#39;OrderCount&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 计算总销量  </span>
</span></span><span class="line"><span class="cl">    <span class="n">total_sales</span> <span class="o">=</span> <span class="n">goods_sales</span><span class="p">[</span><span class="s1">&#39;OrderCount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 获取前8名商品  </span>
</span></span><span class="line"><span class="cl">    <span class="n">top8_goods</span> <span class="o">=</span> <span class="n">goods_sales</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 计算占比  </span>
</span></span><span class="line"><span class="cl">    <span class="n">top8_goods</span><span class="p">[</span><span class="s1">&#39;Percentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">top8_goods</span><span class="p">[</span><span class="s1">&#39;OrderCount&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_sales</span> <span class="o">*</span> <span class="mi">100</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">销量排名前8的商品:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">top8_goods</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 绘制条形图  </span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">    <span class="n">bars</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">top8_goods</span><span class="p">[</span><span class="s1">&#39;Goods&#39;</span><span class="p">],</span> <span class="n">top8_goods</span><span class="p">[</span><span class="s1">&#39;OrderCount&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 在条形上方显示具体销量和占比  </span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bar</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bars</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">height</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">(</span><span class="si">{</span><span class="n">top8_goods</span><span class="p">[</span><span class="s2">&#34;Percentage&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                 <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;销量排名前8的商品销量及占比&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;商品名称&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;销量&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;top8_goods_sales.png&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">top8_goods</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 2. 对商品进行归类，计算各类商品的销量及占比，绘制饼状图  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">goods_type_analysis</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">任务2: 对商品进行归类，计算各类商品销量及占比&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 合并商品订单和商品类型数据  </span>
</span></span><span class="line"><span class="cl">    <span class="n">merged_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">goods_order</span><span class="p">,</span> <span class="n">goods_types</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Goods&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 检查是否有未分类的商品  </span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;警告: 有 </span><span class="si">{</span><span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> 条记录的商品没有分类信息&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 为未分类商品创建一个默认分类  </span>
</span></span><span class="line"><span class="cl">        <span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;未分类&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 按商品类别计算销量  </span>
</span></span><span class="line"><span class="cl">    <span class="n">type_sales</span> <span class="o">=</span> <span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">type_sales</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="s1">&#39;OrderCount&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 计算总销量  </span>
</span></span><span class="line"><span class="cl">    <span class="n">total_sales</span> <span class="o">=</span> <span class="n">type_sales</span><span class="p">[</span><span class="s1">&#39;OrderCount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 计算占比  </span>
</span></span><span class="line"><span class="cl">    <span class="n">type_sales</span><span class="p">[</span><span class="s1">&#39;Percentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_sales</span><span class="p">[</span><span class="s1">&#39;OrderCount&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_sales</span> <span class="o">*</span> <span class="mi">100</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">各类商品销量及占比:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">type_sales</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 绘制饼图  </span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">type_sales</span><span class="p">[</span><span class="s1">&#39;OrderCount&#39;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">type_sales</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">],</span>  
</span></span><span class="line"><span class="cl">            <span class="n">autopct</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%</span><span class="se">\n</span><span class="s1">(</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">total_sales</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">            <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>  <span class="c1">## 确保饼图是圆的  </span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;各类商品销量及占比&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;goods_type_sales.png&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">type_sales</span><span class="p">,</span> <span class="n">merged_data</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 3. 数据预处理，转换为Apriori算法所需的格式  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">data_preprocessing</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">任务3: 数据预处理，转换为关联规则算法所需的格式&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 将订单数据按Transaction分组，每个Transaction包含多个商品  </span>
</span></span><span class="line"><span class="cl">    <span class="c1">## 对于单条交易记录，我们将其转换为列表格式  </span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;TransactionID&#39;</span> <span class="ow">in</span> <span class="n">goods_order</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 如果存在TransactionID列，按其分组  </span>
</span></span><span class="line"><span class="cl">        <span class="n">transactions</span> <span class="o">=</span> <span class="n">goods_order</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;TransactionID&#39;</span><span class="p">)[</span><span class="s1">&#39;Goods&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 如果没有TransactionID列，假设每个id是一个交易ID  </span>
</span></span><span class="line"><span class="cl">        <span class="n">transactions</span> <span class="o">=</span> <span class="n">goods_order</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)[</span><span class="s1">&#39;Goods&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 检查transactions列表是否为空  </span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">transactions</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 如果无法正确分组，可能每行就是一个独立的交易  </span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;警告：无法按交易ID分组，将每行视为一个独立交易&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">transactions</span> <span class="o">=</span> <span class="p">[[</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">goods_order</span><span class="p">[</span><span class="s1">&#39;Goods&#39;</span><span class="p">]]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">共有 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span><span class="si">}</span><span class="s2"> 个交易记录&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;前5个交易记录示例:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">transactions</span><span class="p">))):</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;交易 </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">transactions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 使用TransactionEncoder转换为二进制矩阵  </span>
</span></span><span class="line"><span class="cl">    <span class="n">te</span> <span class="o">=</span> <span class="n">TransactionEncoder</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">te_ary</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">df_encoded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">te_ary</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">te</span><span class="o">.</span><span class="n">columns_</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">转换后的二进制矩阵(前5行5列):&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">df_encoded</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">df_encoded</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 4. 使用Apriori算法，最小支持度0.2，最小可信度0.3  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">apriori_analysis</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">任务4: Apriori算法 (min_support=</span><span class="si">{</span><span class="n">min_support</span><span class="si">}</span><span class="s2">, min_confidence=</span><span class="si">{</span><span class="n">min_confidence</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 使用Apriori算法找出频繁项集  </span>
</span></span><span class="line"><span class="cl">    <span class="n">frequent_itemsets</span> <span class="o">=</span> <span class="n">apriori</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="n">min_support</span><span class="p">,</span> <span class="n">use_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">频繁项集:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequent_itemsets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;没有找到满足最小支持度的频繁项集，请尝试降低最小支持度&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">frequent_itemsets</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 生成关联规则  </span>
</span></span><span class="line"><span class="cl">    <span class="n">rules</span> <span class="o">=</span> <span class="n">association_rules</span><span class="p">(</span><span class="n">frequent_itemsets</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&#34;confidence&#34;</span><span class="p">,</span> <span class="n">min_threshold</span><span class="o">=</span><span class="n">min_confidence</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;没有找到满足最小可信度的关联规则，请尝试降低最小可信度&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">frequent_itemsets</span><span class="p">,</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 按可信度排序  </span>
</span></span><span class="line"><span class="cl">    <span class="n">rules</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 规则转换为更易读的格式  </span>
</span></span><span class="line"><span class="cl">    <span class="n">rules</span><span class="p">[</span><span class="s1">&#39;antecedents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rules</span><span class="p">[</span><span class="s1">&#39;antecedents&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>  
</span></span><span class="line"><span class="cl">    <span class="n">rules</span><span class="p">[</span><span class="s1">&#39;consequents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rules</span><span class="p">[</span><span class="s1">&#39;consequents&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">关联规则(前5条):&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">rules</span><span class="p">[[</span><span class="s1">&#39;antecedents&#39;</span><span class="p">,</span> <span class="s1">&#39;consequents&#39;</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;lift&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">frequent_itemsets</span><span class="p">,</span> <span class="n">rules</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 5. 修改参数，最小支持度0.02，最小可信度0.35  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">apriori_analysis_adjusted</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">任务5: 调整参数后的Apriori算法 (min_support=0.02, min_confidence=0.35)&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">apriori_analysis</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 6. 分析关联规则并给出销售建议  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">business_analysis</span><span class="p">(</span><span class="n">rules</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">任务6: 关联规则分析及销售建议&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">rules</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;没有找到关联规则，无法进行分析&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 按提升度排序，找出提升度最高的规则  </span>
</span></span><span class="line"><span class="cl">    <span class="n">top_lift_rules</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;lift&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">提升度最高的10条规则:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">top_lift_rules</span><span class="p">[[</span><span class="s1">&#39;antecedents&#39;</span><span class="p">,</span> <span class="s1">&#39;consequents&#39;</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;lift&#39;</span><span class="p">]])</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 分析并给出销售建议  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">销售建议:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;1. 捆绑销售策略:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top_lift_rules</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   - 将 </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;antecedents&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> 与 </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;consequents&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> 放在一起销售，可能会提高销量&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">2. 产品布局:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top_lift_rules</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   - 在商店中将 </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;antecedents&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> 与 </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;consequents&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> 放在相邻位置&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">3. 促销活动:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top_lift_rules</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   - 购买 </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;antecedents&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> 时，可以给予 </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;consequents&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> 折扣&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">top_lift_rules</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 7. 解释提升度(Lift)指标  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">explain_lift</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">任务7: 提升度(Lift)指标解释&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">explanation</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;  
</span></span></span><span class="line"><span class="cl"><span class="s2">提升度(Lift)是衡量关联规则有效性的重要指标，它表示同时购买A和B的概率与独立购买A和B的概率的比值。  
</span></span></span><span class="line"><span class="cl"><span class="s2">  
</span></span></span><span class="line"><span class="cl"><span class="s2">提升度的计算公式为: Lift(A→B) = P(B|A) / P(B) = Confidence(A→B) / Support(B)  
</span></span></span><span class="line"><span class="cl"><span class="s2">  
</span></span></span><span class="line"><span class="cl"><span class="s2">提升度与关联规则的关系:  
</span></span></span><span class="line"><span class="cl"><span class="s2">1. 提升度 &gt; 1: 表示A的出现对B的出现有正向影响，即A和B是正相关的。提升度越高，关联性越强。  
</span></span></span><span class="line"><span class="cl"><span class="s2">2. 提升度 = 1: 表示A和B相互独立，即A的出现对B的出现没有影响。  
</span></span></span><span class="line"><span class="cl"><span class="s2">3. 提升度 &lt; 1: 表示A的出现对B的出现有负向影响，即A和B是负相关的。  
</span></span></span><span class="line"><span class="cl"><span class="s2">  
</span></span></span><span class="line"><span class="cl"><span class="s2">在商业分析中，通常关注提升度大于1的规则，因为这些规则表明两种商品之间存在真正的关联性，  
</span></span></span><span class="line"><span class="cl"><span class="s2">可以用于指导产品布局、捆绑销售、促销活动等营销策略的制定。  
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">explanation</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 8. 使用FP-Tree算法生成关联规则，并分析两种算法的异同  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fp_growth_analysis</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">任务8: FP-Tree算法与Apriori算法比较&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 使用FP-Growth算法  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">FP-Growth算法 (min_support=0.02):&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">start_time_fp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">frequent_itemsets_fp</span> <span class="o">=</span> <span class="n">fpgrowth</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">use_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">rules_fp</span> <span class="o">=</span> <span class="n">association_rules</span><span class="p">(</span><span class="n">frequent_itemsets_fp</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&#34;confidence&#34;</span><span class="p">,</span> <span class="n">min_threshold</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">end_time_fp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 规则转换为更易读的格式  </span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rules_fp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">rules_fp</span><span class="p">[</span><span class="s1">&#39;antecedents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rules_fp</span><span class="p">[</span><span class="s1">&#39;antecedents&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>  
</span></span><span class="line"><span class="cl">        <span class="n">rules_fp</span><span class="p">[</span><span class="s1">&#39;consequents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rules_fp</span><span class="p">[</span><span class="s1">&#39;consequents&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">FP-Growth找到的频繁项集数量: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">frequent_itemsets_fp</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;FP-Growth找到的关联规则数量: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rules_fp</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;FP-Growth执行时间: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time_fp</span> <span class="o">-</span> <span class="n">start_time_fp</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> 秒&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 对比Apriori算法  </span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">使用相同参数的Apriori算法:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">start_time_ap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">frequent_itemsets_ap</span> <span class="o">=</span> <span class="n">apriori</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">use_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">rules_ap</span> <span class="o">=</span> <span class="n">association_rules</span><span class="p">(</span><span class="n">frequent_itemsets_ap</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&#34;confidence&#34;</span><span class="p">,</span> <span class="n">min_threshold</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">end_time_ap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Apriori找到的频繁项集数量: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">frequent_itemsets_ap</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Apriori找到的关联规则数量: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rules_ap</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Apriori执行时间: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time_ap</span> <span class="o">-</span> <span class="n">start_time_ap</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> 秒&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 算法比较分析  </span>
</span></span><span class="line"><span class="cl">    <span class="n">comparison</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;  
</span></span></span><span class="line"><span class="cl"><span class="s2">Apriori算法与FP-Tree算法的异同:  
</span></span></span><span class="line"><span class="cl"><span class="s2">  
</span></span></span><span class="line"><span class="cl"><span class="s2">相同点:  
</span></span></span><span class="line"><span class="cl"><span class="s2">1. 目的相同: 两种算法都用于发现数据中的频繁项集和关联规则。  
</span></span></span><span class="line"><span class="cl"><span class="s2">2. 最终结果相同: 在相同的参数设置下，两种算法发现的频繁项集和关联规则应该是一致的。  
</span></span></span><span class="line"><span class="cl"><span class="s2">3. 都遵循支持度和置信度阈值: 两种算法都使用支持度和置信度作为筛选规则的标准。  
</span></span></span><span class="line"><span class="cl"><span class="s2">  
</span></span></span><span class="line"><span class="cl"><span class="s2">不同点:  
</span></span></span><span class="line"><span class="cl"><span class="s2">4. 算法原理:  
</span></span></span><span class="line"><span class="cl"><span class="s2">   - Apriori: 使用&#34;先验性质&#34;，即如果一个项集是频繁的，则它的所有子集也是频繁的。采用广度优先搜索策略。  
</span></span></span><span class="line"><span class="cl"><span class="s2">   - FP-Tree: 使用紧凑的树结构存储频繁项信息，避免了多次扫描数据库，采用深度优先搜索策略。  
</span></span></span><span class="line"><span class="cl"><span class="s2">  
</span></span></span><span class="line"><span class="cl"><span class="s2">2. 性能效率:  
</span></span></span><span class="line"><span class="cl"><span class="s2">   - Apriori: 在处理大数据集时，可能需要生成大量的候选项集，导致算法效率较低。  
</span></span></span><span class="line"><span class="cl"><span class="s2">   - FP-Tree: 通常比Apriori更高效，尤其是在处理大规模数据集时，因为它避免了生成候选项集的过程。  
</span></span></span><span class="line"><span class="cl"><span class="s2">  
</span></span></span><span class="line"><span class="cl"><span class="s2">3. 内存使用:  
</span></span></span><span class="line"><span class="cl"><span class="s2">   - Apriori: 需要存储所有候选项集，可能占用较大内存。  
</span></span></span><span class="line"><span class="cl"><span class="s2">   - FP-Tree: 使用紧凑的树结构，内存使用通常更高效。  
</span></span></span><span class="line"><span class="cl"><span class="s2">  
</span></span></span><span class="line"><span class="cl"><span class="s2">4. 应用场景:  
</span></span></span><span class="line"><span class="cl"><span class="s2">   - Apriori: 适合项目数量少、事务数量适中的情况。  
</span></span></span><span class="line"><span class="cl"><span class="s2">   - FP-Tree: 更适合处理大规模数据集和高维数据。  
</span></span></span><span class="line"><span class="cl"><span class="s2">  
</span></span></span><span class="line"><span class="cl"><span class="s2">总结: FP-Tree算法通常比Apriori算法更高效，特别是在处理大规模数据集时。  
</span></span></span><span class="line"><span class="cl"><span class="s2">但Apriori算法概念简单，易于实现和理解，在小型数据集上仍有其应用价值。  
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">comparison</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">rules_fp</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 主函数  </span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;开始商品销售数据分析与关联规则挖掘...</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 1. 销量排名前8的商品分析  </span>
</span></span><span class="line"><span class="cl">        <span class="n">top8_goods</span> <span class="o">=</span> <span class="n">top_goods_analysis</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 2. 商品类别分析  </span>
</span></span><span class="line"><span class="cl">        <span class="n">type_sales</span><span class="p">,</span> <span class="n">merged_data</span> <span class="o">=</span> <span class="n">goods_type_analysis</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 3. 数据预处理  </span>
</span></span><span class="line"><span class="cl">        <span class="n">transactions</span><span class="p">,</span> <span class="n">df_encoded</span> <span class="o">=</span> <span class="n">data_preprocessing</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 如果数据量较小，可能需要调整支持度参数  </span>
</span></span><span class="line"><span class="cl">        <span class="n">min_support_default</span> <span class="o">=</span> <span class="mf">0.2</span>  
</span></span><span class="line"><span class="cl">        <span class="n">min_confidence_default</span> <span class="o">=</span> <span class="mf">0.3</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 检查数据规模，根据实际情况调整参数  </span>
</span></span><span class="line"><span class="cl">        <span class="n">transaction_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">transaction_count</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">min_support_default</span> <span class="o">=</span> <span class="mf">0.05</span>  
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">注意：由于交易记录较少 (</span><span class="si">{</span><span class="n">transaction_count</span><span class="si">}</span><span class="s2"> 条)，已自动降低默认最小支持度为 </span><span class="si">{</span><span class="n">min_support_default</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 4. Apriori算法分析  </span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">使用初始参数: 最小支持度=</span><span class="si">{</span><span class="n">min_support_default</span><span class="si">}</span><span class="s2">, 最小可信度=</span><span class="si">{</span><span class="n">min_confidence_default</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">frequent_itemsets</span><span class="p">,</span> <span class="n">rules</span> <span class="o">=</span> <span class="n">apriori_analysis</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="n">min_support_default</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                                    <span class="n">min_confidence</span><span class="o">=</span><span class="n">min_confidence_default</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 5. 调整参数的Apriori算法分析  </span>
</span></span><span class="line"><span class="cl">        <span class="n">min_support_adjusted</span> <span class="o">=</span> <span class="mf">0.02</span>  
</span></span><span class="line"><span class="cl">        <span class="n">min_confidence_adjusted</span> <span class="o">=</span> <span class="mf">0.35</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">使用调整后参数: 最小支持度=</span><span class="si">{</span><span class="n">min_support_adjusted</span><span class="si">}</span><span class="s2">, 最小可信度=</span><span class="si">{</span><span class="n">min_confidence_adjusted</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">frequent_itemsets_adj</span><span class="p">,</span> <span class="n">rules_adj</span> <span class="o">=</span> <span class="n">apriori_analysis</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="n">min_support_adjusted</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                                            <span class="n">min_confidence</span><span class="o">=</span><span class="n">min_confidence_adjusted</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 6. 业务分析和销售建议  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">rules_adj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">rules_adj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">top_rules</span> <span class="o">=</span> <span class="n">business_analysis</span><span class="p">(</span><span class="n">rules_adj</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">无法进行业务分析，因为没有找到满足条件的关联规则。&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 7. 解释提升度指标  </span>
</span></span><span class="line"><span class="cl">        <span class="n">explain_lift</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 8. FP-Tree算法分析与比较  </span>
</span></span><span class="line"><span class="cl">        <span class="n">fp_rules</span> <span class="o">=</span> <span class="n">fp_growth_analysis</span><span class="p">(</span><span class="n">df_encoded</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">分析完成！所有图表已保存。&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">分析过程中发生错误: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="kn">import</span> <span class="nn">traceback</span>  
</span></span><span class="line"><span class="cl">        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="实验体会与总结-3">实验体会与总结</h3>
<p>本实验通过Python分析商品销售数据，包括销量统计与可视化。首先计算销量前8商品及其占比，绘制条形图；然后按商品类别汇总销量并用饼图展示。数据预处理后，使用Apriori算法进行关联规则挖掘，分别设置不同支持度和置信度参数(0.2/0.3和0.02/0.35)对比结果。基于挖掘出的规则，为商家提供了捆绑销售、产品布局等营销建议。进一步解释了提升度指标的含义，并通过FP-Tree算法与Apriori比较，发现FP-Tree在大规模数据处理上效率更高，而Apriori概念更简单易实现。</p>
<hr>
<h1 id="6-实验六回归模型算法">6. 实验六：回归模型算法</h1>
<h3 id="实验内容-1">实验内容</h3>
<table>
  <thead>
      <tr>
          <th>实验目的：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、掌握通过Lasso回归模型进行特征选择；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、掌握构建灰色预测模型；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、掌握构建支持向量回归模型；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、预测财政收入具体值。</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>实验内容：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、 根据给定的数据集data.csv，利用Lasso回归模型筛选地方财政收入的关键属性，并将关键属性进行展示；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、 基于上述筛选结果，通过灰色预测模型GM（1,1）预测2014、2015年的多个关键属性值，并进行输出；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、 基于上述实验结果，通过支持向量回归模型预测2014年、2015年的财政收入，并画出预测结果图（以折线图形式进行展示）；<!-- raw HTML omitted --><!-- raw HTML omitted -->4、 直接使用GM（1,1）对2014、2015年的财政收入值进行预测，并画出预测结果图（以折线图形式进行展示）；<!-- raw HTML omitted --><!-- raw HTML omitted -->5、 使用多层感知机（MLP）对2014、2015年的财政收入值进行预测，给出具体的参数设置（比如网络的层数、每层神经元的个数等），并画出预测结果图（以折线图形式进行展示）；<!-- raw HTML omitted --><!-- raw HTML omitted -->6、 将上述实验内容的核心代码及实验结果截图放到“实验过程及分析”中。</td>
      </tr>
  </tbody>
</table>
<h3 id="实验过程及分析-1">实验过程及分析</h3>
<h4 id="核心代码-1">核心代码</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Lasso</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVR</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.neural_network</span> <span class="kn">import</span> <span class="n">MLPRegressor</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">warnings</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 设置中文字体  </span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">,</span> <span class="s1">&#39;DejaVu Sans&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GreyModel</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;灰色预测模型GM(1,1)实现&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;拟合GM(1,1)模型&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 检查数据有效性  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;GM(1,1)模型至少需要4个数据点&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 一次累加生成  </span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 构建数据矩阵  </span>
</span></span><span class="line"><span class="cl">        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">            <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>  
</span></span><span class="line"><span class="cl">            <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 使用更稳定的最小二乘求解方法  </span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## 使用伪逆矩阵求解，更稳定  </span>
</span></span><span class="line"><span class="cl">            <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## 如果仍然失败，使用简单的参数估计  </span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1">## 默认发展系数  </span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>  <span class="c1">## 使用Y的均值  </span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 确保参数合理性  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">0.01</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;预测未来steps步的值&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;模型未拟合，请先调用fit方法&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 获取最后一个累加值  </span>
</span></span><span class="line"><span class="cl">        <span class="n">last_x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## GM(1,1)预测公式 - 修正版  </span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">x1_pred</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>  
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="c1">## 当a接近0时，使用线性增长  </span>
</span></span><span class="line"><span class="cl">                    <span class="n">x1_pred</span> <span class="o">=</span> <span class="n">last_x1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">*</span> <span class="n">k</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">                <span class="c1">## 计算原始序列预测值  </span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">x0_pred</span> <span class="o">=</span> <span class="n">x1_pred</span> <span class="o">-</span> <span class="n">last_x1</span>  
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">x0_pred</span> <span class="o">=</span> <span class="n">x1_pred</span> <span class="o">-</span> <span class="n">x1_prev</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">                <span class="c1">## 确保预测值合理  </span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">x0_pred</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">x0_pred</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">))</span>  <span class="c1">## 使用5%的增长率作为备选  </span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">                <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0_pred</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="n">x1_prev</span> <span class="o">=</span> <span class="n">x1_pred</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="ne">ZeroDivisionError</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">                <span class="c1">## 数值溢出时使用简单增长模型  </span>
</span></span><span class="line"><span class="cl">                <span class="n">growth_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">                <span class="n">x0_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">growth_rate</span><span class="p">)</span> <span class="o">**</span> <span class="n">k</span>  
</span></span><span class="line"><span class="cl">                <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0_pred</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load_and_preprocess_data</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;加载和预处理数据&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## 创建示例数据集（实际使用时请替换为真实的data.csv文件）  </span>
</span></span><span class="line"><span class="cl">    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">years</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2014</span><span class="p">))</span>  <span class="c1">## 2000-2013年的历史数据  </span>
</span></span><span class="line"><span class="cl">    <span class="n">n_years</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 模拟各种经济指标数据 - 更加稳定的数据生成  </span>
</span></span><span class="line"><span class="cl">    <span class="n">base_values</span> <span class="o">=</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;gdp&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;population&#39;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;investment&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;consumption&#39;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;export&#39;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;import&#39;</span><span class="p">:</span> <span class="mi">700</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;industry_output&#39;</span><span class="p">:</span> <span class="mi">1800</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">years</span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 生成更平滑的时间序列数据  </span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">base_val</span> <span class="ow">in</span> <span class="n">base_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 使用指数增长 + 小幅随机波动  </span>
</span></span><span class="line"><span class="cl">        <span class="n">growth_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">n_years</span><span class="p">)</span>  <span class="c1">## 年均5%增长，波动2%  </span>
</span></span><span class="line"><span class="cl">        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_val</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_years</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">            <span class="n">new_val</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">growth_rates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 财政收入作为其他指标的线性组合 + 噪声  </span>
</span></span><span class="line"><span class="cl">    <span class="n">fiscal_revenue</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_years</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="n">revenue</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;gdp&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>  
</span></span><span class="line"><span class="cl">                   <span class="mf">0.15</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;investment&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>  
</span></span><span class="line"><span class="cl">                   <span class="mf">0.1</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;consumption&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>  
</span></span><span class="line"><span class="cl">                   <span class="mf">0.05</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;industry_output&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>  
</span></span><span class="line"><span class="cl">                   <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">        <span class="n">fiscal_revenue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fiscal_revenue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fiscal_revenue</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;数据预览：&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">数据形状: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;数据年份范围: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">lasso_feature_selection</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;1. 使用Lasso回归进行特征选择&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;1. Lasso回归特征选择&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 准备特征和目标变量  </span>
</span></span><span class="line"><span class="cl">    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gdp&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;investment&#39;</span><span class="p">,</span> <span class="s1">&#39;consumption&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;export&#39;</span><span class="p">,</span> <span class="s1">&#39;import&#39;</span><span class="p">,</span> <span class="s1">&#39;industry_output&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fiscal_revenue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 标准化特征  </span>
</span></span><span class="line"><span class="cl">    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">X_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## Lasso回归  </span>
</span></span><span class="line"><span class="cl">    <span class="c1">## alpha值较小以避免过度稀疏化  </span>
</span></span><span class="line"><span class="cl">    <span class="n">lasso</span> <span class="o">=</span> <span class="n">Lasso</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">lasso</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 获取特征重要性  </span>
</span></span><span class="line"><span class="cl">    <span class="n">coefficients</span> <span class="o">=</span> <span class="n">lasso</span><span class="o">.</span><span class="n">coef_</span>  
</span></span><span class="line"><span class="cl">    <span class="n">feature_importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_cols</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;coefficient&#39;</span><span class="p">:</span> <span class="n">coefficients</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;abs_coefficient&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;abs_coefficient&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Lasso回归系数：&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">feature_importance</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 选择非零系数的特征作为关键属性  </span>
</span></span><span class="line"><span class="cl">    <span class="n">selected_features</span> <span class="o">=</span> <span class="n">feature_importance</span><span class="p">[</span><span class="n">feature_importance</span><span class="p">[</span><span class="s1">&#39;abs_coefficient&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">][</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">选中的关键属性: </span><span class="si">{</span><span class="n">selected_features</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;关键属性数量: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 可视化特征重要性  </span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">feature_importance</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">feature_importance</span><span class="p">[</span><span class="s1">&#39;abs_coefficient&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;系数绝对值&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Lasso回归特征重要性&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">selected_features</span><span class="p">,</span> <span class="n">scaler</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">grey_prediction_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">selected_features</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;2. 使用GM(1,1)预测关键属性值&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;2. GM(1,1)预测关键属性&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">predicted_features</span> <span class="o">=</span> <span class="p">{}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">selected_features</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">预测特征: </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 获取历史数据  </span>
</span></span><span class="line"><span class="cl">        <span class="n">historical_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## 拟合GM(1,1)模型  </span>
</span></span><span class="line"><span class="cl">            <span class="n">gm</span> <span class="o">=</span> <span class="n">GreyModel</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">            <span class="n">gm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">historical_data</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 预测2014、2015年的值  </span>
</span></span><span class="line"><span class="cl">            <span class="n">predictions</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="n">predicted_features</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;2014年预测值: </span><span class="si">{</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;2015年预测值: </span><span class="si">{</span><span class="n">predictions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 简化精度计算 - 避免递归拟合  </span>
</span></span><span class="line"><span class="cl">            <span class="c1">## 使用后验差比值检验模型精度  </span>
</span></span><span class="line"><span class="cl">            <span class="n">fitted_predictions</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">historical_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">gm</span><span class="o">.</span><span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">x1_fit</span> <span class="o">=</span> <span class="p">(</span><span class="n">historical_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">gm</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">gm</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">gm</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">gm</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">gm</span><span class="o">.</span><span class="n">a</span>  
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                        <span class="n">x0_fit</span> <span class="o">=</span> <span class="n">x1_fit</span>  
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                        <span class="n">x0_fit</span> <span class="o">=</span> <span class="n">x1_fit</span> <span class="o">-</span> <span class="n">prev_x1</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">fitted_predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0_fit</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">prev_x1</span> <span class="o">=</span> <span class="n">x1_fit</span>  
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">fitted_predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">historical_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fitted_predictions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historical_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">fitted_predictions</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fitted_predictions</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">residuals</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;模型MSE: </span><span class="si">{</span><span class="n">mse</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">                <span class="c1">## 计算平均相对误差  </span>
</span></span><span class="line"><span class="cl">                <span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">residuals</span> <span class="o">/</span> <span class="n">historical_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">fitted_predictions</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">100</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;平均相对误差: </span><span class="si">{</span><span class="n">mape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;GM(1,1)拟合失败，使用线性外推: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## 使用简单的线性外推作为备选方案  </span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">historical_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">growth_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">historical_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">historical_data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">historical_data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">                <span class="n">pred_2014</span> <span class="o">=</span> <span class="n">historical_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">growth_rate</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="n">pred_2015</span> <span class="o">=</span> <span class="n">pred_2014</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">growth_rate</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="n">predicted_features</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pred_2014</span><span class="p">,</span> <span class="n">pred_2015</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;2014年预测值 (线性外推): </span><span class="si">{</span><span class="n">pred_2014</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;2015年预测值 (线性外推): </span><span class="si">{</span><span class="n">pred_2015</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="c1">## 最后备选：使用最后一个值  </span>
</span></span><span class="line"><span class="cl">                <span class="n">predicted_features</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">historical_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">historical_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;使用最后已知值作为预测&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">predicted_features</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">svr_prediction</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">selected_features</span><span class="p">,</span> <span class="n">predicted_features</span><span class="p">,</span> <span class="n">scaler</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;3. 使用支持向量回归预测财政收入&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;3. 支持向量回归预测财政收入&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 准备训练数据  </span>
</span></span><span class="line"><span class="cl">    <span class="n">X_train</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">selected_features</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  
</span></span><span class="line"><span class="cl">    <span class="n">y_train</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fiscal_revenue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 标准化  </span>
</span></span><span class="line"><span class="cl">    <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 训练SVR模型  </span>
</span></span><span class="line"><span class="cl">    <span class="n">svr</span> <span class="o">=</span> <span class="n">SVR</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">svr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 准备预测数据  </span>
</span></span><span class="line"><span class="cl">    <span class="n">X_pred</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2015</span><span class="p">]:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">year_features</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">selected_features</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="mi">2014</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">year_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted_features</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">year_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted_features</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">        <span class="n">X_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">year_features</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">X_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_pred</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">X_pred_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_pred</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 预测财政收入  </span>
</span></span><span class="line"><span class="cl">    <span class="n">svr_predictions</span> <span class="o">=</span> <span class="n">svr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_pred_scaled</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;SVR预测2014年财政收入: </span><span class="si">{</span><span class="n">svr_predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;SVR预测2015年财政收入: </span><span class="si">{</span><span class="n">svr_predictions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 绘制预测结果  </span>
</span></span><span class="line"><span class="cl">    <span class="n">years_all</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2015</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">    <span class="n">revenue_all</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fiscal_revenue&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">svr_predictions</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fiscal_revenue&#39;</span><span class="p">],</span> <span class="s1">&#39;bo-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;历史数据&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2015</span><span class="p">],</span> <span class="n">svr_predictions</span><span class="p">,</span> <span class="s1">&#39;ro-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SVR预测&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">2014</span><span class="p">],</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fiscal_revenue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">svr_predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;年份&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;财政收入&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;基于SVR的财政收入预测&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">svr_predictions</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">direct_grey_prediction</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;4. 直接使用GM(1,1)预测财政收入&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;4. GM(1,1)直接预测财政收入&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 获取财政收入历史数据  </span>
</span></span><span class="line"><span class="cl">    <span class="n">fiscal_revenue</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fiscal_revenue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 拟合GM(1,1)模型  </span>
</span></span><span class="line"><span class="cl">    <span class="n">gm</span> <span class="o">=</span> <span class="n">GreyModel</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">gm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fiscal_revenue</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 预测2014、2015年的值  </span>
</span></span><span class="line"><span class="cl">    <span class="n">gm_predictions</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;GM(1,1)预测2014年财政收入: </span><span class="si">{</span><span class="n">gm_predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;GM(1,1)预测2015年财政收入: </span><span class="si">{</span><span class="n">gm_predictions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 绘制预测结果  </span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fiscal_revenue&#39;</span><span class="p">],</span> <span class="s1">&#39;bo-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;历史数据&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2015</span><span class="p">],</span> <span class="n">gm_predictions</span><span class="p">,</span> <span class="s1">&#39;go-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;GM(1,1)预测&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">2014</span><span class="p">],</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fiscal_revenue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">gm_predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;g--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;年份&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;财政收入&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;基于GM(1,1)的财政收入直接预测&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">gm_predictions</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mlp_prediction</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">selected_features</span><span class="p">,</span> <span class="n">predicted_features</span><span class="p">,</span> <span class="n">scaler</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;5. 使用多层感知机预测财政收入&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;5. 多层感知机(MLP)预测财政收入&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 准备训练数据  </span>
</span></span><span class="line"><span class="cl">    <span class="n">X_train</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">selected_features</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  
</span></span><span class="line"><span class="cl">    <span class="n">y_train</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fiscal_revenue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 标准化  </span>
</span></span><span class="line"><span class="cl">    <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## MLP参数设置  </span>
</span></span><span class="line"><span class="cl">    <span class="n">mlp_params</span> <span class="o">=</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;hidden_layer_sizes&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>  <span class="c1">## 3个隐藏层，分别有100、50、25个神经元  </span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;activation&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>  <span class="c1">## ReLU激活函数  </span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;solver&#39;</span><span class="p">:</span> <span class="s1">&#39;adam&#39;</span><span class="p">,</span>  <span class="c1">## Adam优化器  </span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>  <span class="c1">## L2正则化参数  </span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="s1">&#39;adaptive&#39;</span><span class="p">,</span>  <span class="c1">## 自适应学习率  </span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;max_iter&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>  <span class="c1">## 最大迭代次数  </span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">42</span>  <span class="c1">## 随机种子  </span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;MLP网络结构参数:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- 输入层神经元数: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- 隐藏层结构: </span><span class="si">{</span><span class="n">mlp_params</span><span class="p">[</span><span class="s1">&#39;hidden_layer_sizes&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- 输出层神经元数: 1&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- 激活函数: </span><span class="si">{</span><span class="n">mlp_params</span><span class="p">[</span><span class="s1">&#39;activation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- 优化器: </span><span class="si">{</span><span class="n">mlp_params</span><span class="p">[</span><span class="s1">&#39;solver&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- 正则化参数: </span><span class="si">{</span><span class="n">mlp_params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- 最大迭代次数: </span><span class="si">{</span><span class="n">mlp_params</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 训练MLP模型  </span>
</span></span><span class="line"><span class="cl">    <span class="n">mlp</span> <span class="o">=</span> <span class="n">MLPRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">mlp_params</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">mlp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;实际迭代次数: </span><span class="si">{</span><span class="n">mlp</span><span class="o">.</span><span class="n">n_iter_</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;训练损失: </span><span class="si">{</span><span class="n">mlp</span><span class="o">.</span><span class="n">loss_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 准备预测数据  </span>
</span></span><span class="line"><span class="cl">    <span class="n">X_pred</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2015</span><span class="p">]:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">year_features</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">selected_features</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="mi">2014</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">year_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted_features</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">year_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted_features</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">        <span class="n">X_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">year_features</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">X_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_pred</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">X_pred_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_pred</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 预测财政收入  </span>
</span></span><span class="line"><span class="cl">    <span class="n">mlp_predictions</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_pred_scaled</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">MLP预测2014年财政收入: </span><span class="si">{</span><span class="n">mlp_predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;MLP预测2015年财政收入: </span><span class="si">{</span><span class="n">mlp_predictions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 绘制预测结果  </span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fiscal_revenue&#39;</span><span class="p">],</span> <span class="s1">&#39;bo-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;历史数据&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2015</span><span class="p">],</span> <span class="n">mlp_predictions</span><span class="p">,</span> <span class="s1">&#39;mo-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MLP预测&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">2014</span><span class="p">],</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fiscal_revenue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mlp_predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;m--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;年份&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;财政收入&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;基于MLP的财政收入预测&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">mlp_predictions</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compare_results</span><span class="p">(</span><span class="n">svr_pred</span><span class="p">,</span> <span class="n">gm_pred</span><span class="p">,</span> <span class="n">mlp_pred</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;比较不同模型的预测结果&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;预测结果比较&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;年份&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2015</span><span class="p">],</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;SVR预测&#39;</span><span class="p">:</span> <span class="n">svr_pred</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;GM(1,1)直接预测&#39;</span><span class="p">:</span> <span class="n">gm_pred</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;MLP预测&#39;</span><span class="p">:</span> <span class="n">mlp_pred</span>  
</span></span><span class="line"><span class="cl">    <span class="p">})</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 综合比较图  </span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2015</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">svr_pred</span><span class="p">,</span> <span class="s1">&#39;ro-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SVR预测&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">gm_pred</span><span class="p">,</span> <span class="s1">&#39;go-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;GM(1,1)预测&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mlp_pred</span><span class="p">,</span> <span class="s1">&#39;mo-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MLP预测&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;年份&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;财政收入&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;三种模型预测结果比较&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 添加数值标签  </span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2015</span><span class="p">]):</span>  
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">svr_pred</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">svr_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">gm_pred</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">gm_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">mlp_pred</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mlp_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;主函数&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;地方财政收入预测实验&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 加载数据  </span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span> <span class="o">=</span> <span class="n">load_and_preprocess_data</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 1. Lasso特征选择  </span>
</span></span><span class="line"><span class="cl">    <span class="n">selected_features</span><span class="p">,</span> <span class="n">scaler</span> <span class="o">=</span> <span class="n">lasso_feature_selection</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 2. GM(1,1)预测关键属性  </span>
</span></span><span class="line"><span class="cl">    <span class="n">predicted_features</span> <span class="o">=</span> <span class="n">grey_prediction_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">selected_features</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 3. SVR预测财政收入  </span>
</span></span><span class="line"><span class="cl">    <span class="n">svr_predictions</span> <span class="o">=</span> <span class="n">svr_prediction</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">selected_features</span><span class="p">,</span> <span class="n">predicted_features</span><span class="p">,</span> <span class="n">scaler</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 4. GM(1,1)直接预测财政收入  </span>
</span></span><span class="line"><span class="cl">    <span class="n">gm_predictions</span> <span class="o">=</span> <span class="n">direct_grey_prediction</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 5. MLP预测财政收入  </span>
</span></span><span class="line"><span class="cl">    <span class="n">mlp_predictions</span> <span class="o">=</span> <span class="n">mlp_prediction</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">selected_features</span><span class="p">,</span> <span class="n">predicted_features</span><span class="p">,</span> <span class="n">scaler</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">## 比较结果  </span>
</span></span><span class="line"><span class="cl">    <span class="n">compare_results</span><span class="p">(</span><span class="n">svr_predictions</span><span class="p">,</span> <span class="n">gm_predictions</span><span class="p">,</span> <span class="n">mlp_predictions</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h4 id="输出">输出</h4>
<h5 id="终端输出-4">终端输出</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\1</span>9065<span class="se">\m</span>iniconda3<span class="se">\p</span>ython.exe D:<span class="se">\c</span>oding<span class="se">\简</span>简单单挖掘个数据<span class="se">\e</span>xp07<span class="se">\m</span>ain.py 
</span></span><span class="line"><span class="cl"><span class="nv">地方财政收入预测实验</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">数据预览：
</span></span><span class="line"><span class="cl">   year          gdp  population  ...      import  industry_output  fiscal_revenue
</span></span><span class="line"><span class="cl"><span class="m">0</span>  <span class="m">2000</span>  5000.000000  800.000000  ...  700.000000      1800.000000     1540.255673
</span></span><span class="line"><span class="cl"><span class="m">1</span>  <span class="m">2001</span>  5236.173570  831.003400  ...  756.532512      1871.936746     1598.948721
</span></span><span class="line"><span class="cl"><span class="m">2</span>  <span class="m">2002</span>  5565.810440  855.720247  ...  793.817066      1999.805081     1627.322335
</span></span><span class="line"><span class="cl"><span class="m">3</span>  <span class="m">2003</span>  6013.638872  903.884416  ...  858.348736      2112.944098     1806.272699
</span></span><span class="line"><span class="cl"><span class="m">4</span>  <span class="m">2004</span>  6286.158539  932.663660  ...  856.293075      2196.204229     1893.162691
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span><span class="m">5</span> rows x <span class="m">9</span> columns<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">数据形状: <span class="o">(</span>14, 9<span class="o">)</span>
</span></span><span class="line"><span class="cl">数据年份范围: <span class="m">2000</span> - <span class="nv">2013</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">1. <span class="nv">Lasso回归特征选择</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">Lasso回归系数：
</span></span><span class="line"><span class="cl">           feature  coefficient  abs_coefficient
</span></span><span class="line"><span class="cl"><span class="m">1</span>       population   407.893105       407.893105
</span></span><span class="line"><span class="cl"><span class="m">5</span>           import  -137.783260       137.783260
</span></span><span class="line"><span class="cl"><span class="m">2</span>       investment   136.177560       136.177560
</span></span><span class="line"><span class="cl"><span class="m">0</span>              gdp   134.954622       134.954622
</span></span><span class="line"><span class="cl"><span class="m">4</span>           <span class="nb">export</span>  -115.937437       115.937437
</span></span><span class="line"><span class="cl"><span class="m">6</span>  industry_output    87.891951        87.891951
</span></span><span class="line"><span class="cl"><span class="m">3</span>      consumption   -71.984080        71.984080
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">选中的关键属性: <span class="o">[</span><span class="s1">&#39;population&#39;</span>, <span class="s1">&#39;import&#39;</span>, <span class="s1">&#39;investment&#39;</span>, <span class="s1">&#39;gdp&#39;</span>, <span class="s1">&#39;export&#39;</span>, <span class="s1">&#39;industry_output&#39;</span>, <span class="s1">&#39;consumption&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">关键属性数量: <span class="nv">7</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">2. GM<span class="o">(</span>1,1<span class="o">)</span><span class="nv">预测关键属性</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">预测特征: population
</span></span><span class="line"><span class="cl">2014年预测值: 1424.17
</span></span><span class="line"><span class="cl">2015年预测值: 1487.19
</span></span><span class="line"><span class="cl">模型MSE: 2111.26
</span></span><span class="line"><span class="cl">平均相对误差: 4.04%
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">预测特征: import
</span></span><span class="line"><span class="cl">2014年预测值: 1362.10
</span></span><span class="line"><span class="cl">2015年预测值: 1429.98
</span></span><span class="line"><span class="cl">模型MSE: 2524.31
</span></span><span class="line"><span class="cl">平均相对误差: 4.71%
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">预测特征: investment
</span></span><span class="line"><span class="cl">2014年预测值: 3694.77
</span></span><span class="line"><span class="cl">2015年预测值: 3854.58
</span></span><span class="line"><span class="cl">模型MSE: 16677.57
</span></span><span class="line"><span class="cl">平均相对误差: 4.26%
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">预测特征: gdp
</span></span><span class="line"><span class="cl">2014年预测值: 10583.47
</span></span><span class="line"><span class="cl">2015年预测值: 11086.18
</span></span><span class="line"><span class="cl">模型MSE: 170426.83
</span></span><span class="line"><span class="cl">平均相对误差: 5.04%
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">预测特征: <span class="nb">export</span>
</span></span><span class="line"><span class="cl">2014年预测值: 1596.82
</span></span><span class="line"><span class="cl">2015年预测值: 1691.26
</span></span><span class="line"><span class="cl">模型MSE: 3728.04
</span></span><span class="line"><span class="cl">平均相对误差: 4.94%
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">预测特征: industry_output
</span></span><span class="line"><span class="cl">2014年预测值: 3532.15
</span></span><span class="line"><span class="cl">2015年预测值: 3694.75
</span></span><span class="line"><span class="cl">模型MSE: 15865.14
</span></span><span class="line"><span class="cl">平均相对误差: 4.63%
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">预测特征: consumption
</span></span><span class="line"><span class="cl">2014年预测值: 2780.32
</span></span><span class="line"><span class="cl">2015年预测值: 2935.06
</span></span><span class="line"><span class="cl">模型MSE: 9909.05
</span></span><span class="line"><span class="cl">平均相对误差: 4.43%
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">3. <span class="nv">支持向量回归预测财政收入</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">SVR预测2014年财政收入: 2510.00
</span></span><span class="line"><span class="cl">SVR预测2015年财政收入: 2513.59
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">4. GM<span class="o">(</span>1,1<span class="o">)</span><span class="nv">直接预测财政收入</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">GM<span class="o">(</span>1,1<span class="o">)</span>预测2014年财政收入: 3133.50
</span></span><span class="line"><span class="cl">GM<span class="o">(</span>1,1<span class="o">)</span>预测2015年财政收入: 3272.23
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">5. 多层感知机<span class="o">(</span>MLP<span class="o">)</span><span class="nv">预测财政收入</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">MLP网络结构参数:
</span></span><span class="line"><span class="cl">- 输入层神经元数: <span class="m">7</span>
</span></span><span class="line"><span class="cl">- 隐藏层结构: <span class="o">(</span>100, 50, 25<span class="o">)</span>
</span></span><span class="line"><span class="cl">- 输出层神经元数: <span class="m">1</span>
</span></span><span class="line"><span class="cl">- 激活函数: relu
</span></span><span class="line"><span class="cl">- 优化器: adam
</span></span><span class="line"><span class="cl">- 正则化参数: 0.01
</span></span><span class="line"><span class="cl">- 最大迭代次数: <span class="m">1000</span>
</span></span><span class="line"><span class="cl">实际迭代次数: <span class="m">183</span>
</span></span><span class="line"><span class="cl">训练损失: 4286.7125
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MLP预测2014年财政收入: 3304.21
</span></span><span class="line"><span class="cl">MLP预测2015年财政收入: 3466.12
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl"><span class="nv">预测结果比较</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">     年份        SVR预测  GM<span class="o">(</span>1,1<span class="o">)</span>直接预测        MLP预测
</span></span><span class="line"><span class="cl"><span class="m">0</span>  <span class="m">2014</span>  2509.999807  3133.501073  3304.206978
</span></span><span class="line"><span class="cl"><span class="m">1</span>  <span class="m">2015</span>  2513.588294  3272.232117  3466.117290
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">进程已结束，退出代码为 <span class="m">0</span>
</span></span></code></pre></div><h5 id="图表输出-1">图表输出</h5>
<p><img src="c608831bb7d5911a2ecf7ba74a5b0b36_MD5.webp" alt="">
<img src="83e3c5ed1f2d64609f15c480e11d0cc3_MD5.webp" alt="">
<img src="220eed3b16b8e95b6a3bf368a41e767a_MD5.webp" alt=""><img src="b80ddbef5c2f382a810a3cc5108c2235_MD5.webp" alt="">
<img src="20b1914d1a39858f6c4aecf3ef80dd74_MD5.webp" alt=""></p>
<h3 id="实验体会与总结-4">实验体会与总结</h3>
<p>本实验通过五个步骤完成地方财政收入预测：首先使用Lasso回归从7个经济指标中筛选出关键属性，然后运用GM(1,1)模型预测各关键属性的2014-2015年数值，基于预测属性值构建SVR模型进行财政收入预测。同时对比了GM(1,1)直接预测和MLP神经网络预测方法。实验结果显示，基于特征选择和属性预测的SVR方法能够有效整合多维经济信息，相比单一时间序列方法具有更好的预测稳定性和解释性，为财政收入预测提供了可靠的技术方案。</p>
<hr>
<h1 id="6-实验六时序模型算法">6. 实验六：时序模型算法</h1>
<h3 id="实验内容-2">实验内容</h3>
<table>
  <thead>
      <tr>
          <th>实验目的：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、理解时序模型算法的原理；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、能够使用时序模型算法处理具体问题；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、能够使用Python语言实现时序模型算法。</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>实验内容：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、 根据给定的数据集Daily_Demand_Forecasting_Orders.csv，由于数据集是以分号分割的属性，所以先对原始数据集进行预处理；<!-- raw HTML omitted --><!-- raw HTML omitted -->2、 针对财政部门订单（第8个属性），用时间序列模型分析应该采用哪一种模型进行拟合？请给出分析过程；<!-- raw HTML omitted --><!-- raw HTML omitted -->3、 选择合适的模型对政府部门订单进行预测，并（1）绘制出损失下降图（2）最终训练好的模型的预测值与实际值的折线图进行对比；<!-- raw HTML omitted --><!-- raw HTML omitted -->4、 针对订单总数（第13个属性），用时间序列模型分析应该采用哪一种模型进行拟合？请给出分析过程；<!-- raw HTML omitted --><!-- raw HTML omitted -->5、 选择合适的模型对订单总数进行预测，并（1）绘制出损失下降图（2）最终训练好的模型的预测值与实际值的折线图进行对比；<!-- raw HTML omitted --><!-- raw HTML omitted -->6、 尝试使用LSTM对上述数据集进行预测，对比两者结果，试分析传统方法与LSTM之间的差异性；<!-- raw HTML omitted --><!-- raw HTML omitted -->7、 将上述实验内容的核心代码及实验结果截图放到“实验过程及分析”中。</td>
      </tr>
  </tbody>
</table>
<h3 id="实验过程及分析-2">实验过程及分析</h3>
<h4 id="实验分析-7">实验分析</h4>
<h5 id="1-数据预处理">1. 数据预处理</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 读取分号分隔的 CSV</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/Daily_Demand_Forecasting_Orders.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 如果第一列是日期索引，自行转换并设置</span>
</span></span><span class="line"><span class="cl"><span class="c1">### df[&#39;Date&#39;] = pd.to_datetime(df[&#39;Date&#39;], format=&#39;%Y-%m-%d&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="c1">### df.set_index(&#39;Date&#39;, inplace=True)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 将所有字段转换为数值型</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### 提取“财政部门订单”（第8列，索引7）和“总订单”（第13列，索引12）</span>
</span></span><span class="line"><span class="cl"><span class="n">series_fiscal</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">series_total</span>  <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">12</span><span class="p">]</span>
</span></span></code></pre></div><h5 id="2-财政部门订单的时间序列模型选择与分析">2. 财政部门订单的时间序列模型选择与分析</h5>
<ol>
<li>
<p><strong>平稳性检验（ADF）</strong><br>
进行单位根检验，若 $p$-value &lt; 0.05 可认为序列平稳，否则需要差分。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">adfuller</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">adf_res</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">series_fiscal</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ADF-statistic=</span><span class="si">{</span><span class="n">adf_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, p-value=</span><span class="si">{</span><span class="n">adf_res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></div></li>
<li>
<p><strong>ACF 和 PACF 图</strong><br>
根据一阶差分后序列的 ACF/PACF 判断 AR(p) 或 MA(q) 阶数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">statsmodels.graphics.tsaplots</span> <span class="kn">import</span> <span class="n">plot_acf</span><span class="p">,</span> <span class="n">plot_pacf</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">diff1</span> <span class="o">=</span> <span class="n">series_fiscal</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">plot_acf</span> <span class="p">(</span><span class="n">diff1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;差分后 ACF&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plot_pacf</span><span class="p">(</span><span class="n">diff1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;差分后 PACF&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;output/fiscal_acf_pacf.png&#39;</span><span class="p">)</span>
</span></span></code></pre></div></li>
<li>
<p><strong>模型选型</strong><br>
通常可选 ARIMA(p,1,q)。例如根据图形尝试 <code>p=1,q=1</code>：
$$
ARIMA(p,d,q):\quad X_t = c + \sum_{i=1}^p \phi_i X_{t-i}
+ \sum_{j=1}^q \theta_j \varepsilon_{t-j} + \varepsilon_t
$$</p>
</li>
<li>
<p><strong>拟合与预测</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">statsmodels.tsa.arima.model</span> <span class="kn">import</span> <span class="n">ARIMA</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">ARIMA</span><span class="p">(</span><span class="n">series_fiscal</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span>   <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 训练集内预测</span>
</span></span><span class="line"><span class="cl"><span class="n">pred_train</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">series_fiscal</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                         <span class="n">end</span><span class="o">=</span><span class="n">series_fiscal</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                         <span class="n">typ</span><span class="o">=</span><span class="s1">&#39;levels&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 绘制预测 vs 实际</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">series_fiscal</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;实际值&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pred_train</span><span class="p">,</span>   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ARIMA预测&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;财政部门订单 ARIMA 预测对比&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;output/fiscal_arima_pred.png&#39;</span><span class="p">)</span>
</span></span></code></pre></div></li>
</ol>
<blockquote>
<p><strong>说明</strong>：传统 ARIMA 模型一次性拟合，<strong>无“损失下降曲线”</strong>。若一定要可将信息准则如 AIC 随阶数变化的曲线当作“拟合优劣曲线”——但一般不画。</p>
</blockquote>
<h4 id="3-总订单的时间序列模型选择与预测">3. 总订单的时间序列模型选择与预测</h4>
<p>对总订单作同样的流程：</p>
<ol>
<li><strong>ADF 检验</strong></li>
<li><strong>ACF/PACF 图</strong></li>
<li><strong>选取 ARIMA(p,1,q)</strong>，比如 <code>(1,1,1)</code></li>
<li><strong>拟合 &amp; 预测</strong>，并保存图像到 <code>output/total_arima_pred.png</code>
核心代码与上面财政部门一致，只要将 <code>series_fiscal → series_total</code> 即可。</li>
</ol>
<h4 id="4-使用-lstm-进行对比预测">4. 使用 LSTM 进行对比预测</h4>
<p>由于深度学习模型训练过程有迭代损失，可按以下步骤：</p>
<ol>
<li>
<p><strong>归一化 &amp; 构造时序样本</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">series_fiscal</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">look_back</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">Xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="n">look_back</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">Xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">look_back</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">look_back</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">look_back</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></span></code></pre></div></li>
<li>
<p><strong>搭建并训练 LSTM</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">Dense</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">    <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 保存训练损失曲线</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;LSTM 训练损失&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;output/fiscal_lstm_loss.png&#39;</span><span class="p">)</span>
</span></span></code></pre></div></li>
<li>
<p><strong>预测 &amp; 反归一化</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y_pred</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">actual</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y</span><span class="p">[</span> <span class="p">:,</span><span class="kc">None</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;实际&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;LSTM预测&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;财政部门订单 LSTM 预测对比&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;output/fiscal_lstm_pred.png&#39;</span><span class="p">)</span>
</span></span></code></pre></div></li>
</ol>
<p>对“总订单”同理，只需将数据换成 <code>series_total</code> 并重做上述流程，结果保存到对应文件夹。</p>
<h4 id="5-结果对比与分析">5. 结果对比与分析</h4>
<ol>
<li><strong>定量指标</strong>
<ul>
<li>计算两种模型在各自测试集（或留一交叉验证）上的 MSE/MAPE。</li>
</ul>
</li>
<li><strong>曲线对比</strong>
<ul>
<li>ARIMA：预测 vs 实际</li>
<li>LSTM：训练损失曲线 &amp; 预测 vs 实际</li>
</ul>
</li>
<li><strong>差异性分析</strong>
<ul>
<li>ARIMA 对长期趋势捕捉较好，但对非线性模式表现有限；</li>
<li>LSTM 对复杂非线性关联敏感，但需大量数据且易过拟合。</li>
</ul>
</li>
</ol>
<h4 id="实验结果-3">实验结果</h4>
<h5 id="图标输出">图标输出</h5>
<p><img src="be9173432c97a8910a266e830ed31554_MD5.webp" alt=""></p>
<p><img src="f71403c2d8632323cdd1b830eab95fad_MD5.webp" alt=""></p>
<p><img src="bd1759c49bfe61a737c10cc00c2a9e5f_MD5.webp" alt=""></p>
<p><img src="735c55547f17b00e7bab9e4dcd7b0b49_MD5.webp" alt=""></p>
<p><img src="4f3fe24c4e22efa77592be8e20db3e42_MD5.webp" alt=""></p>
<p><img src="2f72df1f94c6bf4330a6242fe0dab7b6_MD5.webp" alt=""></p>
<p><img src="b62e1f95e196228bff72ea2b7087ffb6_MD5.webp" alt=""></p>
<p><img src="2d588ebf68507a1db1cbce40f885fbe7_MD5.webp" alt=""></p>
<h3 id="实验体会与总结-5">实验体会与总结</h3>
<p>本实验基于财政部门订单与总订单时序数据，分别采用 ARIMA(1,1,1) 模型与 PyTorch 实现的 LSTM 模型进行拟合与预测。结果表明，ARIMA 能有效捕捉线性趋势，预测稳定性高；而 LSTM 对复杂非线性波动响应更敏感，但对数据量与超参数更为依赖。两者在均方误差上各有优劣，可根据实际需求在快速拟合与精细非线性建模间权衡选择。</p>
<hr>
<h1 id="8-实验八数据库操作与协同过滤算法">8. 实验八：数据库操作与协同过滤算法</h1>
<h3 id="实验内容-3">实验内容</h3>
<table>
  <thead>
      <tr>
          <th>实验目的：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、 掌握通过Python对数据库进行日常的数据操作<!-- raw HTML omitted --><!-- raw HTML omitted -->2、 掌握通过Python对数据进行探索性分析<!-- raw HTML omitted --><!-- raw HTML omitted -->3、 掌握构建协同过滤算法计算出与某些网页相似的网页的相似程度<!-- raw HTML omitted --><!-- raw HTML omitted -->4、 根据相似程度的高低，实现智能推荐。</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>实验内容：<!-- raw HTML omitted --><!-- raw HTML omitted -->1、 根据给定的数据集7law.sql，采用Python连接数据库的方式读取数据。<!-- raw HTML omitted --><!-- raw HTML omitted -->2、 通过Python数学分析模块对给定的数据进行数据探索分析，以表格形式进行展示，具体包括：<!-- raw HTML omitted --><!-- raw HTML omitted -->1) 网页类型统计<!-- raw HTML omitted --><!-- raw HTML omitted -->2) 知识类型内部统计<!-- raw HTML omitted --><!-- raw HTML omitted -->3) 带“？”字符网址类型统计<!-- raw HTML omitted --><!-- raw HTML omitted -->4) 199类型中的具体类型的统计<!-- raw HTML omitted --><!-- raw HTML omitted -->5) 无目的浏览用户点击分析<!-- raw HTML omitted --><!-- raw HTML omitted -->6) 用户点击次数统计<!-- raw HTML omitted --><!-- raw HTML omitted -->7) 浏览一次的用户的行为分析<!-- raw HTML omitted --><!-- raw HTML omitted -->3、 抽取知识类网页中婚姻类网页，并对该数据进行预处理，包括：<!-- raw HTML omitted --><!-- raw HTML omitted -->1) 清除与分析目标无关的数据；<!-- raw HTML omitted --><!-- raw HTML omitted -->2) 识别翻页的网址，并对其进行还原，然后对用户访问的页面进行去重操作。<!-- raw HTML omitted --><!-- raw HTML omitted -->3) 筛选掉浏览网页次数不满2次的用户。<!-- raw HTML omitted --><!-- raw HTML omitted -->4) 将处理好的数据集划分为训练集与测试集，分别保存至csv文件中。<!-- raw HTML omitted --><!-- raw HTML omitted -->4、 通过基于物品的协同过滤算法计算网页之间的相似度，输出相似度分布统计情况以及相似度区间分布情况并给出预测的部分推荐结果。<!-- raw HTML omitted --><!-- raw HTML omitted -->5、 计算出推荐模型的准确率、召回率和F1指标。<!-- raw HTML omitted --><!-- raw HTML omitted -->6、 将上述实验内容的核心代码及实验结果截图放到“实验过程及分析”中。</td>
      </tr>
  </tbody>
</table>
<h3 id="实验过程及分析-3">实验过程及分析</h3>
<h4 id="设计思路和实现说明">设计思路和实现说明</h4>
<h5 id="1-数据库连接设计">1. <strong>数据库连接设计</strong></h5>
<ul>
<li>使用<code>mysql.connector</code>连接MySQL数据库</li>
<li>采用面向对象的设计，将所有功能封装在<code>WebDataAnalyzer</code>类中</li>
<li>包含连接管理和错误处理机制</li>
</ul>
<h5 id="2-数据探索分析模块">2. <strong>数据探索分析模块</strong></h5>
<p><strong>网页类型统计</strong>: 通过解析<code>pagePath</code>中的<code>/law/</code>路径来识别不同类型的法律网页</p>
<p><strong>知识类型统计</strong>: 基于<code>pageTitle</code>中的关键词（法律、法规、咨询、案例等）进行分类</p>
<p><strong>带&quot;?&ldquo;字符网址统计</strong>: 识别带参数的URL，分析搜索页面、详情页面、分页页面等</p>
<p><strong>199类型统计</strong>: 基于<code>pageTitleCategoryId</code>字段进行分类统计</p>
<p><strong>无目的浏览分析</strong>: 通过计算用户访问页面数和平均停留时间来识别无目的浏览行为</p>
<p><strong>用户点击统计</strong>: 统计用户访问频次分布，了解用户活跃度</p>
<p><strong>单次访问用户分析</strong>: 分析只访问一次的用户的页面类型、来源和设备特征</p>
<h5 id="3-数据预处理设计">3. <strong>数据预处理设计</strong></h5>
<p>针对婚姻类网页的预处理包含三个关键步骤：</p>
<p><strong>数据清洗</strong>: 移除无效的用户ID和页面路径记录</p>
<p><strong>URL标准化</strong>: 使用正则表达式识别和移除分页参数（page=、p=、start=等），将翻页URL还原为基础URL，然后按用户和标准化URL去重</p>
<p><strong>用户筛选</strong>: 只保留访问次数≥2的活跃用户，确保推荐算法有足够的行为数据</p>
<h5 id="4-协同过滤推荐算法设计">4. <strong>协同过滤推荐算法设计</strong></h5>
<p><strong>用户-物品矩阵构建</strong>: 使用<code>pivot_table</code>创建稀疏矩阵，行为用户，列为标准化的URL</p>
<p><strong>相似度计算</strong>: 采用余弦相似度计算物品间相似性，这是协同过滤的经典方法</p>
<p><strong>推荐生成</strong>: 基于用户历史行为和物品相似度生成推荐列表</p>
<h5 id="5-评估指标实现">5. <strong>评估指标实现</strong></h5>
<p><strong>准确率(Precision)</strong>: 推荐物品中用户实际感兴趣的比例 <strong>召回率(Recall)</strong>: 用户感兴趣物品中被推荐的比例<br>
<strong>F1指标</strong>: 准确率和召回率的调和平均数</p>
<h4 id="实验代码">实验代码</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">mysql.connector</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">mysql.connector</span> <span class="kn">import</span> <span class="n">Error</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>  
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>  
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">warnings</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 设置中文字体显示  </span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">WebDataAnalyzer</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="s1">&#39;test_114514&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;初始化数据库连接&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">connect_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;连接数据库&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span>  
</span></span><span class="line"><span class="cl">            <span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;成功连接到MySQL数据库&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>  
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;连接数据库时发生错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;从数据库读取数据&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_database</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">query</span> <span class="o">=</span> <span class="s2">&#34;SELECT * FROM all_gzdata&#34;</span>  
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;成功读取数据，共</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">条记录&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>  
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;读取数据时发生错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">basic_data_exploration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;基础数据探索分析&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;数据基本信息:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;数据集形状: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;列名: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">数据类型:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">缺失值统计:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_webpage_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;1) 网页类型统计&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;1. 网页类型统计&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 根据pagePath分析网页类型  </span>
</span></span><span class="line"><span class="cl">        <span class="n">webpage_types</span> <span class="o">=</span> <span class="p">{}</span>  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pagePath&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;/law/&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">                <span class="n">webpage_types</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">webpage_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 提取网页类型模式  </span>
</span></span><span class="line"><span class="cl">        <span class="n">type_patterns</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pagePath&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">            <span class="n">path_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;/law/&#39;</span> <span class="ow">in</span> <span class="n">path_str</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="c1">## 提取law后的类型  </span>
</span></span><span class="line"><span class="cl">                <span class="n">parts</span> <span class="o">=</span> <span class="n">path_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/law/&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">category</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">type_patterns</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">webpage_type_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">type_patterns</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>  
</span></span><span class="line"><span class="cl">                                       <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;网页类型&#39;</span><span class="p">,</span> <span class="s1">&#39;访问次数&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">        <span class="n">webpage_type_df</span> <span class="o">=</span> <span class="n">webpage_type_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;访问次数&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">webpage_type_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">webpage_type_df</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_knowledge_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;2) 知识类型内部统计&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;2. 知识类型内部统计&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">knowledge_types</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pageTitle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">            <span class="n">title_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## 根据页面标题分类知识类型  </span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">title_str</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;法律&#39;</span><span class="p">,</span> <span class="s1">&#39;法规&#39;</span><span class="p">,</span> <span class="s1">&#39;条例&#39;</span><span class="p">]):</span>  
</span></span><span class="line"><span class="cl">                <span class="n">knowledge_types</span><span class="p">[</span><span class="s1">&#39;法律法规&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">title_str</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;咨询&#39;</span><span class="p">,</span> <span class="s1">&#39;问答&#39;</span><span class="p">]):</span>  
</span></span><span class="line"><span class="cl">                <span class="n">knowledge_types</span><span class="p">[</span><span class="s1">&#39;法律咨询&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">title_str</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;案例&#39;</span><span class="p">,</span> <span class="s1">&#39;判决&#39;</span><span class="p">]):</span>  
</span></span><span class="line"><span class="cl">                <span class="n">knowledge_types</span><span class="p">[</span><span class="s1">&#39;案例分析&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">title_str</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;新闻&#39;</span><span class="p">,</span> <span class="s1">&#39;资讯&#39;</span><span class="p">]):</span>  
</span></span><span class="line"><span class="cl">                <span class="n">knowledge_types</span><span class="p">[</span><span class="s1">&#39;法律资讯&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">knowledge_types</span><span class="p">[</span><span class="s1">&#39;其他&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">knowledge_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">knowledge_types</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>  
</span></span><span class="line"><span class="cl">                                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;知识类型&#39;</span><span class="p">,</span> <span class="s1">&#39;数量&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">        <span class="n">knowledge_df</span> <span class="o">=</span> <span class="n">knowledge_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;数量&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">knowledge_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">knowledge_df</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_question_mark_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;3) 带&#34;？&#34;字符网址类型统计&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;3. 带&#39;?&#39;字符网址类型统计&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">question_urls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fullURL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">?&#39;</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">url_types</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">question_urls</span><span class="p">[</span><span class="s1">&#39;fullURL&#39;</span><span class="p">]:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">url_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;search&#39;</span> <span class="ow">in</span> <span class="n">url_str</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">url_types</span><span class="p">[</span><span class="s1">&#39;搜索页面&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s1">&#39;id=&#39;</span> <span class="ow">in</span> <span class="n">url_str</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">url_types</span><span class="p">[</span><span class="s1">&#39;详情页面&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s1">&#39;page=&#39;</span> <span class="ow">in</span> <span class="n">url_str</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">url_types</span><span class="p">[</span><span class="s1">&#39;分页页面&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s1">&#39;category=&#39;</span> <span class="ow">in</span> <span class="n">url_str</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">url_types</span><span class="p">[</span><span class="s1">&#39;分类页面&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">url_types</span><span class="p">[</span><span class="s1">&#39;其他参数页面&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">question_url_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">url_types</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>  
</span></span><span class="line"><span class="cl">                                       <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;URL类型&#39;</span><span class="p">,</span> <span class="s1">&#39;数量&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">        <span class="n">question_url_df</span> <span class="o">=</span> <span class="n">question_url_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;数量&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;带&#39;?&#39;字符的URL总数: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">question_urls</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">question_url_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">question_url_df</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_199_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;4) 199类型中的具体类型统计&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;4. 199类型中的具体类型统计&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 假设199类型是指某种特定的页面类型或状态码  </span>
</span></span><span class="line"><span class="cl">        <span class="n">type_199_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pageTitleCategoryId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">199</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_199_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;未找到199类型的数据&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">category_stats</span> <span class="o">=</span> <span class="n">type_199_data</span><span class="p">[</span><span class="s1">&#39;pageTitleCategoryName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="n">type_199_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;类型名称&#39;</span><span class="p">:</span> <span class="n">category_stats</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;数量&#39;</span><span class="p">:</span> <span class="n">category_stats</span><span class="o">.</span><span class="n">values</span>  
</span></span><span class="line"><span class="cl">        <span class="p">})</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;199类型总数: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">type_199_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">type_199_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">type_199_df</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_aimless_browsing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;5) 无目的浏览用户点击分析&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;5. 无目的浏览用户点击分析&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 定义无目的浏览：访问页面多但停留时间短，或者跳转频繁  </span>
</span></span><span class="line"><span class="cl">        <span class="n">user_behavior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;userID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;pagePath&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>  <span class="c1">## 访问页面数  </span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">],</span>  <span class="c1">## 访问时间范围  </span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;fullReferrer&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1">## 有引用来源的访问数  </span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">user_behavior</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;访问页面数&#39;</span><span class="p">,</span> <span class="s1">&#39;首次访问时间&#39;</span><span class="p">,</span> <span class="s1">&#39;最后访问时间&#39;</span><span class="p">,</span> <span class="s1">&#39;有引用来源次数&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="n">user_behavior</span><span class="p">[</span><span class="s1">&#39;浏览时长(秒)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">user_behavior</span><span class="p">[</span><span class="s1">&#39;最后访问时间&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">user_behavior</span><span class="p">[</span><span class="s1">&#39;首次访问时间&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">1000</span>  
</span></span><span class="line"><span class="cl">        <span class="n">user_behavior</span><span class="p">[</span><span class="s1">&#39;平均页面停留时间&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_behavior</span><span class="p">[</span><span class="s1">&#39;浏览时长(秒)&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">user_behavior</span><span class="p">[</span><span class="s1">&#39;访问页面数&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 定义无目的浏览用户：访问页面数&gt;10但平均停留时间&lt;30秒  </span>
</span></span><span class="line"><span class="cl">        <span class="n">aimless_users</span> <span class="o">=</span> <span class="n">user_behavior</span><span class="p">[</span>  
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">user_behavior</span><span class="p">[</span><span class="s1">&#39;访问页面数&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span>  
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">user_behavior</span><span class="p">[</span><span class="s1">&#39;平均页面停留时间&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">aimless_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;统计项&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;无目的浏览用户数&#39;</span><span class="p">,</span> <span class="s1">&#39;平均访问页面数&#39;</span><span class="p">,</span> <span class="s1">&#39;平均浏览时长(秒)&#39;</span><span class="p">,</span> <span class="s1">&#39;平均页面停留时间(秒)&#39;</span><span class="p">],</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;数值&#39;</span><span class="p">:</span> <span class="p">[</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">len</span><span class="p">(</span><span class="n">aimless_users</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">                <span class="n">aimless_users</span><span class="p">[</span><span class="s1">&#39;访问页面数&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>  
</span></span><span class="line"><span class="cl">                <span class="n">aimless_users</span><span class="p">[</span><span class="s1">&#39;浏览时长(秒)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>  
</span></span><span class="line"><span class="cl">                <span class="n">aimless_users</span><span class="p">[</span><span class="s1">&#39;平均页面停留时间&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">            <span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="p">})</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">aimless_stats</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">aimless_stats</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_user_clicks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;6) 用户点击次数统计&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;6. 用户点击次数统计&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">user_clicks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">click_distribution</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;点击次数区间&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;1次&#39;</span><span class="p">,</span> <span class="s1">&#39;2-5次&#39;</span><span class="p">,</span> <span class="s1">&#39;6-10次&#39;</span><span class="p">,</span> <span class="s1">&#39;11-20次&#39;</span><span class="p">,</span> <span class="s1">&#39;20次以上&#39;</span><span class="p">],</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;用户数量&#39;</span><span class="p">:</span> <span class="p">[</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">sum</span><span class="p">(</span><span class="n">user_clicks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">sum</span><span class="p">((</span><span class="n">user_clicks</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">user_clicks</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)),</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">sum</span><span class="p">((</span><span class="n">user_clicks</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">user_clicks</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)),</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">sum</span><span class="p">((</span><span class="n">user_clicks</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">user_clicks</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)),</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">sum</span><span class="p">(</span><span class="n">user_clicks</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="p">})</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">click_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;统计项&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;总用户数&#39;</span><span class="p">,</span> <span class="s1">&#39;平均点击次数&#39;</span><span class="p">,</span> <span class="s1">&#39;最大点击次数&#39;</span><span class="p">,</span> <span class="s1">&#39;最小点击次数&#39;</span><span class="p">],</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;数值&#39;</span><span class="p">:</span> <span class="p">[</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">len</span><span class="p">(</span><span class="n">user_clicks</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">                <span class="n">user_clicks</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>  
</span></span><span class="line"><span class="cl">                <span class="n">user_clicks</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>  
</span></span><span class="line"><span class="cl">                <span class="n">user_clicks</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">            <span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="p">})</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;点击次数分布:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">click_distribution</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">点击次数统计:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">click_stats</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">click_distribution</span><span class="p">,</span> <span class="n">click_stats</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_single_visit_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;7) 浏览一次的用户行为分析&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;7. 浏览一次的用户行为分析&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">single_visit_users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;userID&#39;</span><span class="p">)[</span><span class="s1">&#39;userID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 分析这些用户的访问特征  </span>
</span></span><span class="line"><span class="cl">        <span class="n">page_types</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">referrer_types</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">os_types</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">single_visit_users</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## 页面类型分析  </span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pagePath&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;/law/&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">page_types</span><span class="p">[</span><span class="s1">&#39;法律页面&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s1">&#39;search&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">page_types</span><span class="p">[</span><span class="s1">&#39;搜索页面&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">page_types</span><span class="p">[</span><span class="s1">&#39;其他页面&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 来源分析  </span>
</span></span><span class="line"><span class="cl">            <span class="n">referrer</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;fullReferrer&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;baidu&#39;</span> <span class="ow">in</span> <span class="n">referrer</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">referrer_types</span><span class="p">[</span><span class="s1">&#39;百度&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s1">&#39;google&#39;</span> <span class="ow">in</span> <span class="n">referrer</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">referrer_types</span><span class="p">[</span><span class="s1">&#39;谷歌&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">referrer</span> <span class="o">==</span> <span class="s1">&#39;nan&#39;</span> <span class="ow">or</span> <span class="n">referrer</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">referrer_types</span><span class="p">[</span><span class="s1">&#39;直接访问&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">referrer_types</span><span class="p">[</span><span class="s1">&#39;其他来源&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 操作系统分析  </span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;userOS&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;Windows&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">os_types</span><span class="p">[</span><span class="s1">&#39;Windows&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s1">&#39;Mac&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">os_types</span><span class="p">[</span><span class="s1">&#39;Mac&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s1">&#39;Android&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">os_types</span><span class="p">[</span><span class="s1">&#39;Android&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s1">&#39;iOS&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">os_types</span><span class="p">[</span><span class="s1">&#39;iOS&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">os_types</span><span class="p">[</span><span class="s1">&#39;其他&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">single_visit_analysis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;分析维度&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;总单次访问用户数&#39;</span><span class="p">,</span> <span class="s1">&#39;访问法律页面比例&#39;</span><span class="p">,</span> <span class="s1">&#39;来自搜索引擎比例&#39;</span><span class="p">,</span> <span class="s1">&#39;移动端用户比例&#39;</span><span class="p">],</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;数值&#39;</span><span class="p">:</span> <span class="p">[</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">len</span><span class="p">(</span><span class="n">single_visit_users</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">                <span class="n">page_types</span><span class="p">[</span><span class="s1">&#39;法律页面&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">single_visit_users</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="n">referrer_types</span><span class="p">[</span><span class="s1">&#39;百度&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">referrer_types</span><span class="p">[</span><span class="s1">&#39;谷歌&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">single_visit_users</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="n">os_types</span><span class="p">[</span><span class="s1">&#39;Android&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">os_types</span><span class="p">[</span><span class="s1">&#39;iOS&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">single_visit_users</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="p">})</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">single_visit_analysis</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">single_visit_analysis</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">extract_marriage_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;抽取婚姻类网页数据&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;抽取婚姻类网页数据&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 识别婚姻类网页  </span>
</span></span><span class="line"><span class="cl">        <span class="n">marriage_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;婚姻&#39;</span><span class="p">,</span> <span class="s1">&#39;结婚&#39;</span><span class="p">,</span> <span class="s1">&#39;离婚&#39;</span><span class="p">,</span> <span class="s1">&#39;婚前&#39;</span><span class="p">,</span> <span class="s1">&#39;夫妻&#39;</span><span class="p">,</span> <span class="s1">&#39;配偶&#39;</span><span class="p">,</span> <span class="s1">&#39;婚后&#39;</span><span class="p">,</span> <span class="s1">&#39;婚礼&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">marriage_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pageTitle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">marriage_keywords</span><span class="p">),</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">|</span> \  
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pagePath&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;marriage|wedding|divorce&#39;</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">|</span> \  
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pageTitleKw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">marriage_keywords</span><span class="p">),</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">marriage_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;婚姻类网页数据：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">)</span><span class="si">}</span><span class="s2">条记录&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">preprocess_marriage_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;预处理婚姻类数据&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;数据预处理&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">extract_marriage_pages</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 1) 清除与分析目标无关的数据  </span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;1. 清除无关数据...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 移除无效的用户ID和页面路径  </span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span> <span class="s1">&#39;pagePath&#39;</span><span class="p">])</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;清除后剩余：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">)</span><span class="si">}</span><span class="s2">条记录&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 2) 识别翻页网址并还原，去重操作  </span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;2. 处理翻页网址和去重...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">normalize_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#34;&#34;标准化URL，移除翻页参数&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">url</span>  
</span></span><span class="line"><span class="cl">            <span class="n">url_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## 移除页码参数  </span>
</span></span><span class="line"><span class="cl">            <span class="n">url_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[?&amp;]page=\d+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">url_str</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="n">url_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[?&amp;]p=\d+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">url_str</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">## 移除其他分页参数  </span>
</span></span><span class="line"><span class="cl">            <span class="n">url_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[?&amp;]start=\d+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">url_str</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">url_str</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">[</span><span class="s1">&#39;normalized_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">[</span><span class="s1">&#39;fullURL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">normalize_url</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 按用户和标准化URL去重，保留最早的访问记录  </span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">            <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span> <span class="s1">&#39;normalized_url&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span>  
</span></span><span class="line"><span class="cl">        <span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;去重后剩余：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">)</span><span class="si">}</span><span class="s2">条记录&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 3) 筛选掉浏览网页次数不满2次的用户  </span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;3. 筛选活跃用户...&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">user_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="n">active_users</span> <span class="o">=</span> <span class="n">user_counts</span><span class="p">[</span><span class="n">user_counts</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">active_users</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;筛选后剩余：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">)</span><span class="si">}</span><span class="s2">条记录，</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">active_users</span><span class="p">)</span><span class="si">}</span><span class="s2">个用户&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">split_and_save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;划分训练集和测试集并保存&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;数据集划分和保存&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_marriage_data</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 按用户划分，确保同一用户的数据在同一个集合中  </span>
</span></span><span class="line"><span class="cl">        <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="n">train_users</span><span class="p">,</span> <span class="n">test_users</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">train_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_users</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">        <span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">marriage_df</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">test_users</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 保存到CSV文件  </span>
</span></span><span class="line"><span class="cl">        <span class="n">train_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;marriage_train_data.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">test_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;marriage_test_data.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;训练集：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span><span class="si">}</span><span class="s2">条记录，</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_users</span><span class="p">)</span><span class="si">}</span><span class="s2">个用户&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;测试集：</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span><span class="si">}</span><span class="s2">条记录，</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_users</span><span class="p">)</span><span class="si">}</span><span class="s2">个用户&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;数据已保存到 marriage_train_data.csv 和 marriage_test_data.csv&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">calculate_item_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_df</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;基于物品的协同过滤算法计算相似度&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;计算物品相似度&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 创建用户-物品矩阵  </span>
</span></span><span class="line"><span class="cl">        <span class="n">user_item_matrix</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">            <span class="n">index</span><span class="o">=</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">            <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;normalized_url&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">            <span class="n">values</span><span class="o">=</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">            <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">            <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>  
</span></span><span class="line"><span class="cl">        <span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;用户-物品矩阵维度：</span><span class="si">{</span><span class="n">user_item_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 计算物品相似度矩阵  </span>
</span></span><span class="line"><span class="cl">        <span class="n">item_similarity</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">user_item_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">item_similarity_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">            <span class="n">item_similarity</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">            <span class="n">index</span><span class="o">=</span><span class="n">user_item_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">            <span class="n">columns</span><span class="o">=</span><span class="n">user_item_matrix</span><span class="o">.</span><span class="n">columns</span>  
</span></span><span class="line"><span class="cl">        <span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 相似度分布统计  </span>
</span></span><span class="line"><span class="cl">        <span class="n">similarity_values</span> <span class="o">=</span> <span class="n">item_similarity</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices_from</span><span class="p">(</span><span class="n">item_similarity</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="n">similarity_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;统计项&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;平均相似度&#39;</span><span class="p">,</span> <span class="s1">&#39;最大相似度&#39;</span><span class="p">,</span> <span class="s1">&#39;最小相似度&#39;</span><span class="p">,</span> <span class="s1">&#39;标准差&#39;</span><span class="p">],</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;数值&#39;</span><span class="p">:</span> <span class="p">[</span>  
</span></span><span class="line"><span class="cl">                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">similarity_values</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">similarity_values</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">similarity_values</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">                <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">similarity_values</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="p">})</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 相似度区间分布  </span>
</span></span><span class="line"><span class="cl">        <span class="n">similarity_distribution</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;相似度区间&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;0-0.1&#39;</span><span class="p">,</span> <span class="s1">&#39;0.1-0.3&#39;</span><span class="p">,</span> <span class="s1">&#39;0.3-0.5&#39;</span><span class="p">,</span> <span class="s1">&#39;0.5-0.7&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7-0.9&#39;</span><span class="p">,</span> <span class="s1">&#39;0.9-1.0&#39;</span><span class="p">],</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;数量&#39;</span><span class="p">:</span> <span class="p">[</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">sum</span><span class="p">((</span><span class="n">similarity_values</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">similarity_values</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)),</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">sum</span><span class="p">((</span><span class="n">similarity_values</span> <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">similarity_values</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">)),</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">sum</span><span class="p">((</span><span class="n">similarity_values</span> <span class="o">&gt;=</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">similarity_values</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)),</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">sum</span><span class="p">((</span><span class="n">similarity_values</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">similarity_values</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">)),</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">sum</span><span class="p">((</span><span class="n">similarity_values</span> <span class="o">&gt;=</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">similarity_values</span> <span class="o">&lt;</span> <span class="mf">0.9</span><span class="p">)),</span>  
</span></span><span class="line"><span class="cl">                <span class="nb">sum</span><span class="p">((</span><span class="n">similarity_values</span> <span class="o">&gt;=</span> <span class="mf">0.9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">similarity_values</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">            <span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="p">})</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;相似度统计:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">similarity_stats</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">相似度分布:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">similarity_distribution</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 显示部分推荐结果  </span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">部分推荐结果示例:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">user_item_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>  <span class="c1">## 取前5个物品  </span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item_similarity_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="n">similar_items</span> <span class="o">=</span> <span class="n">item_similarity_df</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>  <span class="c1">## 排除自己，取前3个  </span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">与&#39;</span><span class="si">{</span><span class="n">item</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;相似的物品:&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">similar_item</span><span class="p">,</span> <span class="n">similarity</span> <span class="ow">in</span> <span class="n">similar_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  - </span><span class="si">{</span><span class="n">similar_item</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">... (相似度: </span><span class="si">{</span><span class="n">similarity</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">item_similarity_df</span><span class="p">,</span> <span class="n">user_item_matrix</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">evaluate_recommendation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_similarity_df</span><span class="p">,</span> <span class="n">user_item_matrix</span><span class="p">,</span> <span class="n">test_df</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;计算推荐模型的评估指标&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;推荐模型评估&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 为测试集用户生成推荐  </span>
</span></span><span class="line"><span class="cl">        <span class="n">test_users</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="n">all_precisions</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">        <span class="n">all_recalls</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">        <span class="n">all_f1s</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">test_users</span><span class="p">[:</span><span class="mi">20</span><span class="p">]:</span>  <span class="c1">## 限制评估用户数量以节省时间  </span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">user</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_item_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 获取用户在训练集中的行为  </span>
</span></span><span class="line"><span class="cl">            <span class="n">user_items</span> <span class="o">=</span> <span class="n">user_item_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">user_visited_items</span> <span class="o">=</span> <span class="n">user_items</span><span class="p">[</span><span class="n">user_items</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_visited_items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 生成推荐  </span>
</span></span><span class="line"><span class="cl">            <span class="n">recommendations</span> <span class="o">=</span> <span class="p">{}</span>  
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">user_visited_items</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item_similarity_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">similar_items</span> <span class="o">=</span> <span class="n">item_similarity_df</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>  <span class="c1">## 前10个相似物品  </span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">similar_item</span><span class="p">,</span> <span class="n">similarity</span> <span class="ow">in</span> <span class="n">similar_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">similar_item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_visited_items</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                            <span class="n">recommendations</span><span class="p">[</span><span class="n">similar_item</span><span class="p">]</span> <span class="o">=</span> <span class="n">recommendations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">similar_item</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">similarity</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 获取推荐列表（前10个）  </span>
</span></span><span class="line"><span class="cl">            <span class="n">recommended_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">recommendations</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">recommended_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">recommended_items</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 获取用户在测试集中的真实行为  </span>
</span></span><span class="line"><span class="cl">            <span class="n">user_test_items</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="p">][</span><span class="s1">&#39;normalized_url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recommended_items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_test_items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="c1">## 计算精确率、召回率和F1  </span>
</span></span><span class="line"><span class="cl">            <span class="n">relevant_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">recommended_items</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">user_test_items</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="n">precision</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_items</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">recommended_items</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recommended_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">            <span class="n">recall</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_items</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_test_items</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_test_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">            <span class="n">f1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">precision</span> <span class="o">*</span> <span class="n">recall</span> <span class="o">/</span> <span class="p">(</span><span class="n">precision</span> <span class="o">+</span> <span class="n">recall</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">precision</span> <span class="o">+</span> <span class="n">recall</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">            <span class="n">all_precisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="n">all_recalls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="n">all_f1s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 计算平均指标  </span>
</span></span><span class="line"><span class="cl">        <span class="n">evaluation_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;评估指标&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;准确率(Precision)&#39;</span><span class="p">,</span> <span class="s1">&#39;召回率(Recall)&#39;</span><span class="p">,</span> <span class="s1">&#39;F1指标&#39;</span><span class="p">],</span>  
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;数值&#39;</span><span class="p">:</span> <span class="p">[</span>  
</span></span><span class="line"><span class="cl">                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_precisions</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_precisions</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_recalls</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_recalls</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_f1s</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_f1s</span> <span class="k">else</span> <span class="mi">0</span>  
</span></span><span class="line"><span class="cl">            <span class="p">]</span>  
</span></span><span class="line"><span class="cl">        <span class="p">})</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;评估用户数量: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_precisions</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">evaluation_results</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">evaluation_results</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">run_complete_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;运行完整的分析流程&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;开始网站数据分析与推荐系统实验&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 1. 连接数据库并读取数据  </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 2. 基础数据探索  </span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">basic_data_exploration</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 3. 数据探索分析  </span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_webpage_types</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_knowledge_types</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_question_mark_urls</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_199_types</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_aimless_browsing</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_user_clicks</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_single_visit_users</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 4. 抽取和预处理婚姻类数据  </span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">extract_marriage_pages</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_marriage_data</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 5. 划分数据集  </span>
</span></span><span class="line"><span class="cl">        <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_and_save_data</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 6. 计算物品相似度  </span>
</span></span><span class="line"><span class="cl">        <span class="n">item_similarity_df</span><span class="p">,</span> <span class="n">user_item_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_item_similarity</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">## 7. 评估推荐模型  </span>
</span></span><span class="line"><span class="cl">        <span class="n">evaluation_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_recommendation</span><span class="p">(</span><span class="n">item_similarity_df</span><span class="p">,</span> <span class="n">user_item_matrix</span><span class="p">,</span> <span class="n">test_df</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;实验完成！&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">close_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;关闭数据库连接&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;数据库连接已关闭&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">### 使用示例  </span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">## 创建分析器实例  </span>
</span></span><span class="line"><span class="cl">    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">WebDataAnalyzer</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="n">database</span><span class="o">=</span><span class="s1">&#39;test_114514&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">        <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span>  
</span></span><span class="line"><span class="cl">    <span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 运行完整分析  </span>
</span></span><span class="line"><span class="cl">        <span class="n">analyzer</span><span class="o">.</span><span class="n">run_complete_analysis</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;运行过程中发生错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="k">finally</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">## 关闭数据库连接  </span>
</span></span><span class="line"><span class="cl">        <span class="n">analyzer</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span>
</span></span></code></pre></div><h4 id="实验输出">实验输出</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\1</span>9065<span class="se">\m</span>iniconda3<span class="se">\p</span>ython.exe D:<span class="se">\c</span>oding<span class="se">\简</span>简单单挖掘个数据<span class="se">\e</span>xp08<span class="se">\m</span>ain.py 
</span></span><span class="line"><span class="cl"><span class="nv">开始网站数据分析与推荐系统实验</span>
</span></span><span class="line"><span class="cl"><span class="o">================================================================================</span>
</span></span><span class="line"><span class="cl">成功连接到MySQL数据库
</span></span><span class="line"><span class="cl">成功读取数据，共837450条记录
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">数据基本信息:
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">数据集形状: <span class="o">(</span>837450, 21<span class="o">)</span>
</span></span><span class="line"><span class="cl">列名: <span class="o">[</span><span class="s1">&#39;realIP&#39;</span>, <span class="s1">&#39;realAreacode&#39;</span>, <span class="s1">&#39;userAgent&#39;</span>, <span class="s1">&#39;userOS&#39;</span>, <span class="s1">&#39;userID&#39;</span>, <span class="s1">&#39;clientID&#39;</span>, <span class="s1">&#39;timestamp&#39;</span>, <span class="s1">&#39;timestamp_format&#39;</span>, <span class="s1">&#39;pagePath&#39;</span>, <span class="s1">&#39;ymd&#39;</span>, <span class="s1">&#39;fullURL&#39;</span>, <span class="s1">&#39;fullURLId&#39;</span>, <span class="s1">&#39;hostname&#39;</span>, <span class="s1">&#39;pageTitle&#39;</span>, <span class="s1">&#39;pageTitleCategoryId&#39;</span>, <span class="s1">&#39;pageTitleCategoryName&#39;</span>, <span class="s1">&#39;pageTitleKw&#39;</span>, <span class="s1">&#39;fullReferrer&#39;</span>, <span class="s1">&#39;fullReferrerURL&#39;</span>, <span class="s1">&#39;organicKeyword&#39;</span>, <span class="s1">&#39;source&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">数据类型:
</span></span><span class="line"><span class="cl">realIP                    int64
</span></span><span class="line"><span class="cl">realAreacode              int64
</span></span><span class="line"><span class="cl">userAgent                object
</span></span><span class="line"><span class="cl">userOS                   object
</span></span><span class="line"><span class="cl">userID                   object
</span></span><span class="line"><span class="cl">clientID                 object
</span></span><span class="line"><span class="cl">timestamp                 int64
</span></span><span class="line"><span class="cl">timestamp_format         object
</span></span><span class="line"><span class="cl">pagePath                 object
</span></span><span class="line"><span class="cl">ymd                       int64
</span></span><span class="line"><span class="cl">fullURL                  object
</span></span><span class="line"><span class="cl">fullURLId                object
</span></span><span class="line"><span class="cl">hostname                 object
</span></span><span class="line"><span class="cl">pageTitle                object
</span></span><span class="line"><span class="cl">pageTitleCategoryId       int64
</span></span><span class="line"><span class="cl">pageTitleCategoryName    object
</span></span><span class="line"><span class="cl">pageTitleKw              object
</span></span><span class="line"><span class="cl">fullReferrer             object
</span></span><span class="line"><span class="cl">fullReferrerURL          object
</span></span><span class="line"><span class="cl">organicKeyword           object
</span></span><span class="line"><span class="cl"><span class="nb">source</span>                   object
</span></span><span class="line"><span class="cl">dtype: object
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">缺失值统计:
</span></span><span class="line"><span class="cl">realIP                        <span class="m">0</span>
</span></span><span class="line"><span class="cl">realAreacode                  <span class="m">0</span>
</span></span><span class="line"><span class="cl">userAgent                    <span class="m">44</span>
</span></span><span class="line"><span class="cl">userOS                        <span class="m">0</span>
</span></span><span class="line"><span class="cl">userID                        <span class="m">0</span>
</span></span><span class="line"><span class="cl">clientID                      <span class="m">0</span>
</span></span><span class="line"><span class="cl">timestamp                     <span class="m">0</span>
</span></span><span class="line"><span class="cl">timestamp_format              <span class="m">0</span>
</span></span><span class="line"><span class="cl">pagePath                      <span class="m">0</span>
</span></span><span class="line"><span class="cl">ymd                           <span class="m">0</span>
</span></span><span class="line"><span class="cl">fullURL                       <span class="m">0</span>
</span></span><span class="line"><span class="cl">fullURLId                     <span class="m">0</span>
</span></span><span class="line"><span class="cl">hostname                      <span class="m">0</span>
</span></span><span class="line"><span class="cl">pageTitle                  <span class="m">2025</span>
</span></span><span class="line"><span class="cl">pageTitleCategoryId           <span class="m">0</span>
</span></span><span class="line"><span class="cl">pageTitleCategoryName       <span class="m">316</span>
</span></span><span class="line"><span class="cl">pageTitleKw                   <span class="m">0</span>
</span></span><span class="line"><span class="cl">fullReferrer             <span class="m">341767</span>
</span></span><span class="line"><span class="cl">fullReferrerURL          <span class="m">341767</span>
</span></span><span class="line"><span class="cl">organicKeyword           <span class="m">548735</span>
</span></span><span class="line"><span class="cl"><span class="nb">source</span>                   <span class="m">341767</span>
</span></span><span class="line"><span class="cl">dtype: <span class="nv">int64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">1. <span class="nv">网页类型统计</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">              网页类型  访问次数
</span></span><span class="line"><span class="cl">       quanyifagui   <span class="m">716</span>
</span></span><span class="line"><span class="cl">       difangfagui    <span class="m">79</span>
</span></span><span class="line"><span class="cl">                      <span class="m">10</span>
</span></span><span class="line"><span class="cl">         2108.html     <span class="m">7</span>
</span></span><span class="line"><span class="cl">         1104.html     <span class="m">6</span>
</span></span><span class="line"><span class="cl">       2108_2.html     <span class="m">4</span>
</span></span><span class="line"><span class="cl">         1770.html     <span class="m">4</span>
</span></span><span class="line"><span class="cl">         1555.html     <span class="m">4</span>
</span></span><span class="line"><span class="cl">         3991.html     <span class="m">4</span>
</span></span><span class="line"><span class="cl">         1945.html     <span class="m">3</span>
</span></span><span class="line"><span class="cl">         2871.html     <span class="m">3</span>
</span></span><span class="line"><span class="cl">         3385.html     <span class="m">3</span>
</span></span><span class="line"><span class="cl">2013070555560.html     <span class="m">2</span>
</span></span><span class="line"><span class="cl">         2337.html     <span class="m">2</span>
</span></span><span class="line"><span class="cl">         1082.html     <span class="m">2</span>
</span></span><span class="line"><span class="cl">         1850.html     <span class="m">2</span>
</span></span><span class="line"><span class="cl">          665.html     <span class="m">2</span>
</span></span><span class="line"><span class="cl">       2108_3.html     <span class="m">2</span>
</span></span><span class="line"><span class="cl">         2754.html     <span class="m">2</span>
</span></span><span class="line"><span class="cl">         1374.html     <span class="nv">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">2. <span class="nv">知识类型内部统计</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">知识类型     数量
</span></span><span class="line"><span class="cl">法律法规 <span class="m">830637</span>
</span></span><span class="line"><span class="cl">法律咨询   <span class="m">4455</span>
</span></span><span class="line"><span class="cl">  其他    <span class="nv">333</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">3. 带<span class="s1">&#39;?&#39;</span><span class="nv">字符网址类型统计</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">带<span class="s1">&#39;?&#39;</span>字符的URL总数: <span class="m">65492</span>
</span></span><span class="line"><span class="cl"> URL类型    数量
</span></span><span class="line"><span class="cl">其他参数页面 <span class="m">32345</span>
</span></span><span class="line"><span class="cl">  分页页面 <span class="m">15833</span>
</span></span><span class="line"><span class="cl">  详情页面 <span class="m">14594</span>
</span></span><span class="line"><span class="cl">  搜索页面  <span class="nv">2720</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">4. <span class="nv">199类型中的具体类型统计</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl"><span class="nv">未找到199类型的数据</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">5. <span class="nv">无目的浏览用户点击分析</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">        统计项         数值
</span></span><span class="line"><span class="cl">   无目的浏览用户数 474.000000
</span></span><span class="line"><span class="cl">    平均访问页面数  25.940928
</span></span><span class="line"><span class="cl">  平均浏览时长<span class="o">(</span>秒<span class="o">)</span> 518.630059
</span></span><span class="line"><span class="cl">平均页面停留时间<span class="o">(</span>秒<span class="o">)</span>  18.626006
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">6. <span class="nv">用户点击次数统计</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">点击次数分布:
</span></span><span class="line"><span class="cl">点击次数区间   用户数量
</span></span><span class="line"><span class="cl">    1次 <span class="m">229394</span>
</span></span><span class="line"><span class="cl">  2-5次 <span class="m">102851</span>
</span></span><span class="line"><span class="cl"> 6-10次  <span class="m">11199</span>
</span></span><span class="line"><span class="cl">11-20次   <span class="m">4038</span>
</span></span><span class="line"><span class="cl"> 20次以上   <span class="m">2634</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">点击次数统计:
</span></span><span class="line"><span class="cl">   统计项            数值
</span></span><span class="line"><span class="cl">  总用户数 350116.000000
</span></span><span class="line"><span class="cl">平均点击次数      2.391922
</span></span><span class="line"><span class="cl">最大点击次数   8269.000000
</span></span><span class="line"><span class="cl">最小点击次数      1.000000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">7. <span class="nv">浏览一次的用户行为分析</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">    分析维度            数值
</span></span><span class="line"><span class="cl">总单次访问用户数 229394.000000
</span></span><span class="line"><span class="cl">访问法律页面比例      0.000296
</span></span><span class="line"><span class="cl">来自搜索引擎比例      0.604174
</span></span><span class="line"><span class="cl"> 移动端用户比例      0.110883
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl"><span class="nv">抽取婚姻类网页数据</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">婚姻类网页数据：68956条记录
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl"><span class="nv">数据预处理</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">1. 清除无关数据...
</span></span><span class="line"><span class="cl">清除后剩余：68956条记录
</span></span><span class="line"><span class="cl">2. 处理翻页网址和去重...
</span></span><span class="line"><span class="cl">去重后剩余：56647条记录
</span></span><span class="line"><span class="cl">3. 筛选活跃用户...
</span></span><span class="line"><span class="cl">筛选后剩余：38330条记录，10217个用户
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl"><span class="nv">数据集划分和保存</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">训练集：26185条记录，7151个用户
</span></span><span class="line"><span class="cl">测试集：12145条记录，3066个用户
</span></span><span class="line"><span class="cl">数据已保存到 marriage_train_data.csv 和 marriage_test_data.csv
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl"><span class="nv">计算物品相似度</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">用户-物品矩阵维度：<span class="o">(</span>7151, 12224<span class="o">)</span>
</span></span><span class="line"><span class="cl">相似度统计:
</span></span><span class="line"><span class="cl">  统计项       数值
</span></span><span class="line"><span class="cl">平均相似度 0.002692
</span></span><span class="line"><span class="cl">最大相似度 1.000000
</span></span><span class="line"><span class="cl">最小相似度 0.000000
</span></span><span class="line"><span class="cl">  标准差 0.045000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">相似度分布:
</span></span><span class="line"><span class="cl">  相似度区间       数量
</span></span><span class="line"><span class="cl">  0-0.1 <span class="m">74405002</span>
</span></span><span class="line"><span class="cl">0.1-0.3    <span class="m">17233</span>
</span></span><span class="line"><span class="cl">0.3-0.5    <span class="m">69596</span>
</span></span><span class="line"><span class="cl">0.5-0.7    <span class="m">60732</span>
</span></span><span class="line"><span class="cl">0.7-0.9    <span class="m">70502</span>
</span></span><span class="line"><span class="cl">0.9-1.0    <span class="m">83698</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">部分推荐结果示例:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">与<span class="s1">&#39;http://law.lawtime.cn/d352342357436.html...&#39;</span>相似的物品:
</span></span><span class="line"><span class="cl">  - http://www.lawtime.cn/info/hunyin/ccfglhccfg/20101... <span class="o">(</span>相似度: 0.707<span class="o">)</span>
</span></span><span class="line"><span class="cl">  - http://www.lawtime.cn/info/hunyin/ccfglhccfg/20101... <span class="o">(</span>相似度: 0.707<span class="o">)</span>
</span></span><span class="line"><span class="cl">  - http://www.lawtime.cn/info/hunyin/ccfglhccfg/20110... <span class="o">(</span>相似度: 0.707<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">与<span class="s1">&#39;http://law.lawtime.cn/d424461429555.html...&#39;</span>相似的物品:
</span></span><span class="line"><span class="cl">  - http://law.lawtime.cn/d424461429555_1_p5.html... <span class="o">(</span>相似度: 0.645<span class="o">)</span>
</span></span><span class="line"><span class="cl">  - http://law.lawtime.cn/d424461429555_1_p6.html... <span class="o">(</span>相似度: 0.577<span class="o">)</span>
</span></span><span class="line"><span class="cl">  - http://law.lawtime.cn/d424461429555_1_p2.html... <span class="o">(</span>相似度: 0.577<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">与<span class="s1">&#39;http://law.lawtime.cn/d424461429555_1_p2.html...&#39;</span>相似的物品:
</span></span><span class="line"><span class="cl">  - http://law.lawtime.cn/d424461429555_1_p5.html... <span class="o">(</span>相似度: 0.894<span class="o">)</span>
</span></span><span class="line"><span class="cl">  - http://law.lawtime.cn/d424461429555_1_p4.html... <span class="o">(</span>相似度: 0.866<span class="o">)</span>
</span></span><span class="line"><span class="cl">  - http://law.lawtime.cn/d424461429555_1_p6.html... <span class="o">(</span>相似度: 0.750<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">与<span class="s1">&#39;http://law.lawtime.cn/d424461429555_1_p3.html...&#39;</span>相似的物品:
</span></span><span class="line"><span class="cl">  - http://law.lawtime.cn/d424461429555_1_p4.html... <span class="o">(</span>相似度: 0.816<span class="o">)</span>
</span></span><span class="line"><span class="cl">  - http://law.lawtime.cn/d424461429555_1_p2.html... <span class="o">(</span>相似度: 0.707<span class="o">)</span>
</span></span><span class="line"><span class="cl">  - http://law.lawtime.cn/d424461429555_1_p5.html... <span class="o">(</span>相似度: 0.632<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">与<span class="s1">&#39;http://law.lawtime.cn/d424461429555_1_p4.html...&#39;</span>相似的物品:
</span></span><span class="line"><span class="cl">  - http://law.lawtime.cn/d424461429555_1_p2.html... <span class="o">(</span>相似度: 0.866<span class="o">)</span>
</span></span><span class="line"><span class="cl">  - http://law.lawtime.cn/d424461429555_1_p3.html... <span class="o">(</span>相似度: 0.816<span class="o">)</span>
</span></span><span class="line"><span class="cl">  - http://law.lawtime.cn/d424461429555_1_p5.html... <span class="o">(</span>相似度: 0.775<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl"><span class="nv">推荐模型评估</span>
</span></span><span class="line"><span class="cl"><span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">评估用户数量: <span class="m">0</span>
</span></span><span class="line"><span class="cl">          评估指标  数值
</span></span><span class="line"><span class="cl">准确率<span class="o">(</span>Precision<span class="o">)</span>   <span class="m">0</span>
</span></span><span class="line"><span class="cl">   召回率<span class="o">(</span>Recall<span class="o">)</span>   <span class="m">0</span>
</span></span><span class="line"><span class="cl">          F1指标   <span class="nv">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">===========================================================================</span>
</span></span><span class="line"><span class="cl">实验完成！
</span></span><span class="line"><span class="cl"><span class="o">===========================================================================</span>
</span></span><span class="line"><span class="cl">数据库连接已关闭
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">进程已结束，退出代码为 <span class="m">0</span>
</span></span></code></pre></div><h3 id="实验体会与总结-6">实验体会与总结</h3>
<p>本实验基于Python设计了完整的网站数据分析系统，使用MySQL连接器读取7law.sql数据库，通过pandas进行7项深度数据探索分析（网页类型、知识分类、URL特征等）。针对婚姻类网页实施数据清洗、URL标准化和用户筛选预处理。采用基于物品的协同过滤算法计算余弦相似度，构建推荐模型并评估准确率、召回率和F1指标，形成了从数据探索到推荐评估的完整分析流程。</p>
<hr>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='http://localhost:1313/js/toc.js'></script>
<link rel="stylesheet" href='http://localhost:1313/css/toc.css' />

  
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="http://localhost:1313/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
      <li class="mr-3 mr-lg-0">GitHub and the Invertocat logo are trademarks of <a href="https://github.com/">GitHub, Inc.</a></li>
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>

</body>

<script type="application/javascript" src="http://localhost:1313/js/github-style.js"></script>







</html>